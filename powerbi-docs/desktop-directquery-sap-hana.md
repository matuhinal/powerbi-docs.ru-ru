---
title: DirectQuery для SAP HANA в Power BI
description: Аспекты использования DirectQuery с SAP HANA
author: davidiseminger
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: conceptual
ms.date: 04/10/2019
ms.author: davidi
LocalizationGroup: Connect to data
ms.openlocfilehash: 86307a871503dd42e565099b810cb82efa109417
ms.sourcegitcommit: 7aa0136f93f88516f97ddd8031ccac5d07863b92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/05/2020
ms.locfileid: "75761233"
---
# <a name="connect-to-sap-hana-data-sources-by-using-directquery-in-power-bi"></a>Подключение к источникам данных SAP HANA напрямую с помощью DirectQuery в Power BI
Вы можете подключиться к источникам данных **SAP HANA** напрямую с помощью **DirectQuery**. К SAP HANA можно подключиться двумя способами:

* **Определение SAP HANA в качестве многомерного источника (используется по умолчанию)** . В этом случае поведение будет таким же, как при подключении Power BI к другим многомерным источникам, таким как SAP Business Warehouse или Analysis Services. Если при подключении к SAP HANA использовать этот параметр, выбирается одно представление аналитики или вычисления, и все меры, иерархии и атрибуты этого представления будут доступны в списке полей. При создании визуализации сводные данные будут всегда извлекаться из SAP HANA. Этот подход является рекомендуемым и используется по умолчанию для новых отчетов DirectQuery на базе SAP HANA.

* **Определение SAP HANA в качестве реляционного источника**. В этом случае SAP HANA в Power BI считается реляционным источником. Такой подход обеспечивает большую гибкость. Но необходимо соблюдать осторожность, чтобы вычисление мер выполнялось правильно и не возникали проблемы с производительностью.

Способ подключения определяется с помощью глобального параметра средства. Чтобы установить этот параметр, последовательно выберите **Файл > Параметры и настройки**, **Параметры > DirectQuery**, а затем параметр **Считать SAP HANA реляционным источником**, как показано на изображении ниже. 

![](media/desktop-directquery-sap-hana/directquery-sap-hana_01a.png)

Параметр "Считать SAP HANA реляционным источником" управляет подходом для всех *новых* отчетов, использующих DirectQuery на базе SAP HANA. Он не влияет ни на подключения SAP HANA в текущем отчете, ни на подключения в других отчетах, которые открыты. Если возле этого параметра флажок снят, после добавления нового подключения к SAP HANA с помощью окна **получения данных** это подключение будет выполняться с SAP HANA в качестве многомерного источника. Но если открыт другой отчет, который тоже подключается к SAP HANA, он будет работать с учетом параметра, установленного *при создании этого отчета*. Это означает, что все отчеты, подключенные к SAP HANA, которые созданы до февраля 2018 г., будут определять SAP HANA как реляционный источник. 

Два подхода формируют разное поведение. Поэтому для существующего отчета невозможно изменить один подход на другой. 

Рассмотрим подробнее каждый из этих подходов.

## <a name="treat-sap-hana-as-a-multi-dimensional-source-default"></a>Определение SAP HANA в качестве многомерного источника (по умолчанию)

Все новые подключения к SAP HANA используют этот способ подключения по умолчанию, считая SAP HANA многомерным источником. Чтобы при подключении платформа SAP HANA определялась как реляционный источник, последовательно выберите **Файл > Параметры и настройки > Параметры** и установите флажок в области **DirectQuery > Считать SAP HANA реляционным источником**. Пока эта функция находится в **предварительной версии**, отчеты, созданные с помощью подхода с многомерным источником, *нельзя* будет публиковать в службе Power BI. Это действие будет приводить к ошибкам при открытии отчета в службе Power BI.  

Ниже описаны особенности, характерные при подключении к SAP HANA как к многомерному источнику.

* В **навигаторе получения данных** можно выбрать одно представление SAP HANA. Нельзя выбрать отдельные меры или атрибуты. Во время подключения запросы не определяются. Это поведение отличается от импорта данных или использования DirectQuery при обработке SAP HANA как реляционного источника. Это также означает, что невозможно непосредственно использовать SQL-запрос SAP HANA, если выбран этот способ подключения.

* Все меры, иерархии и атрибуты из выбранного представления будут отображаться в списке полей. 

* Так как мера используется в визуализации, к SAP HANA будет направлен запрос для получения значения меры на уровне агрегирования, который требуется для визуализации. Поэтому при работе с неаддитивными мерами (счетчики, коэффициенты и т. д.) все операции агрегирования создает SAP HANA, и после этого службе Power BI не нужно создавать их. 

* Чтобы всегда получать из SAP HANA правильные значения вычислений, нужно соблюдать некоторые ограничения. Например, запрещено добавлять вычисляемые столбцы и объединять данные из нескольких представлений SAP HANA в одном отчете. 

Если при подключении к SAP HANA эта платформа считается многомерным источником, отсутствует гибкость, доступная при использовании альтернативного *реляционного* подхода. Но этот способ проще использовать, он гарантирует правильные значения вычислений при работе с более сложными мерами SAP HANA и в целом обеспечивает более высокую производительность. 

Список **Поле** будет включать все меры, атрибуты и иерархии из представления SAP HANA. Обратите внимание на поведение при использовании этого метода подключения.

* Атрибуты, которые включены хотя бы в одну иерархию, будут скрыты по умолчанию. Но если в контекстном меню списка полей выбрать параметр **Показать скрытые**, эти атрибуты отобразятся. При необходимости в этом же контекстном меню можно сделать атрибуты видимыми.

* В SAP HANA можно определить атрибут для использования другого атрибута в качестве его метки. Например, атрибут **Product** со значениями 1, 2, 3 и т. д. можно использовать в качестве метки атрибута **ProductName** со значениями "Велосипед", "Рубашка", "Перчатки" и т. д. В этом случае одно поле **Product** будет отображаться в списке полей, значениями которых будут метки "Велосипед", "Рубашка", "Перчатки" и т. д. Но эти значения будут отсортированы по уникальности и по ключевым значениям 1, 2, 3. Кроме того, можно создать скрытый столбец **Product.Key**, чтобы при необходимости предоставлять доступ к базовым значениям ключа. 

Все переменные, определенные в базовом представлении SAP HANA, отображаются во время подключения, и для них можно ввести необходимые значения. Эти значения можно впоследствии изменить. Для этого выберите на ленте **Изменить запросы**, а затем в раскрывающемся меню выберите **Управление параметрами**. 

Разрешаются более строгие операции моделирования, чем при стандартном использовании DirectQuery. Это нужно, чтобы из SAP HANA можно было всегда получить правильные данные вычислений. Но при этом можно вносить дополнения и изменения, например определять меры, переименовывать и скрывать поля, выбирать форматы отображения. Все изменения сохраняются при обновлении, и неконфликтующие изменения, внесенные в представление SAP HANA, будут применены. 

### <a name="additional-modeling-restrictions"></a>Дополнительные ограничения моделирования

Ниже перечислены основные дополнительные ограничения моделирования при подключении к SAP HANA с помощью DirectQuery в Power BI (HANA считается многомерным источником): 

* **Вычисляемые столбцы не поддерживаются.** Возможность создания вычисляемых столбцов отключена. Это также означает, что группирование и кластеризация, которые создают вычисляемые столбцы, недоступны.
* **Дополнительные ограничения для мер.** На выражения DAX, которые могут использоваться в мерах, накладываются дополнительные ограничения. Они зависят от уровня поддержки, предоставляемого SAP HANA.
* **Определение связей не поддерживается.** В отчете можно подать запрос только на одно представление. Поэтому определение связей не поддерживается.
* **Нет представления данных.** **Представление данных** обычно отображает детальные данные в таблицах. Учитывая характер источников OLAP, таких как SAP HANA, это представление недоступно для SAP HANA.
* **Сведения о столбцах и мерах фиксированы.** Список столбцов и мер, которые видны в списке полей, фиксируется базовым источником и не может быть изменен. Например, нельзя удалить столбец или изменить его тип данных. Но его можно переименовать.
* **Дополнительные ограничения в DAX.** Для функций DAX, которые могут использоваться в определениях мер, накладываются дополнительные ограничения в соответствии с ограничениями в источнике. Например, нельзя использовать агрегатную функцию для таблицы.

### <a name="additional-visualization-restrictions"></a>Дополнительные ограничения визуализации

Ниже перечислены ограничения для визуализаций при подключении к SAP HANA с помощью DirectQuery в Power BI (HANA считается многомерным источником): 
* **Агрегирование столбцов не поддерживается.** Нельзя изменить агрегирование столбца для визуализации. Всегда указано значение *Не вычислять итоговое значение*.

## <a name="treat-sap-hana-as-a-relational-source"></a>Определение SAP HANA в качестве реляционного источника 

Если выбрать подключение к SAP HANA как реляционному источнику, будут доступны дополнительные гибкие возможности. Например, можно создать вычисляемые столбцы, включить данные из нескольких представлений SAP HANA и создать связи между итоговыми таблицами. Но при таком использовании SAP HANA важно понимать, как обрабатываются подключения, чтобы обеспечить следующее поведение: 

* результаты отображаются правильно, если представление SAP HANA содержит неаддитивные меры (например, число или среднее значение различных объектов, а не обычные сумы);
* полученные запросы эффективны.

Когда запрос, определенный в разделе **получения данных** или **редакторе запросов**, выполняет агрегирование, сначала необходимо уточнить поведение реляционного источника, такого как SQL Server. В следующем примере запрос, определенный в **редакторе запросов**, возвращает значение средней цены по *ProductID*.  

![](media/desktop-directquery-sap-hana/directquery-sap-hana_01.png)

Если импортировать данные в Power BI (вместо использования DirectQuery), мы получим следующие результаты:

* Данные будут импортированы на уровне агрегата, определенного запросом, созданным в **редакторе запросов**. Например, средняя цена продукта. В результате мы получаем таблицу с двумя столбцами, *ProductID* и *AveragePrice*, которые можно использовать в визуальных элементах.
* В визуальном элементе любое последующее агрегирование (например, *Sum*, *Average*, *Min* и другие) выполняется над импортируемыми данными. Например, если включить *AveragePrice* в визуализацию, по умолчанию будет выполняться вычисление *Sum* и возвращаться сумма *AveragePrice* для каждого *ProductID*. В нашем примере это 13,67. Это же правило применяется для альтернативных агрегатных функций (*Min*, *Average* и т. д.), используемых в визуальных элементах. Например, значение *Average* колонки *AveragePrice* возвращает среднее значение для 6,66, 4 и 3, которое равно 4,56, а не среднее значение столбца *Price* с шестью записями в базовой таблице, равное 5,17.
  
Если вместо импорта использовать **DirectQuery** (для того же реляционного источника), будет применена та же семантика и результаты будут совпадать.  

* Рассматривая тот же запрос, точно такие же логические данные будут представлены на уровне отчета, хотя фактически они не импортированы.

* В визуальном элементе любое последующее агрегирование (*Sum*, *Average*, *Min* и другие) снова выполняется над логической таблицей из запроса. Как видим, визуальный элемент, который содержит *среднее значение* записей в колонке *AveragePrice*, возвращает то же значение — 4,56.
  
Теперь посмотрим, как работает SAP HANA, если при подключении она определена как реляционный источник. В SAP HANA Power BI может работать с *аналитическими представлениями* и *представлениями вычисления*, которые могут содержать меры. Но подход к использованию SAP HANA основан на тех же принципах, которые описаны ранее в этом разделе. Запрос в разделе **получения данных** или **редакторе запросов** определяет доступные данные, после чего любая последующая операция агрегирования в визуализации выполняется с использованием этих данных. Это же правило применяется для импорта и DirectQuery.  
Однако принимая во внимание особенности SAP HANA, запрос, определенный в исходном диалоговом окне **Получение данных** или **редакторе запросов**, всегда статистический и, как правило, включает меры, где фактическое используемое агрегирование определяется представлением SAP HANA.

Эквивалентом приведенного выше примера SQL Server является представление SAP HANA, содержащее записи *ID*, *ProductID*, *DepotID* и меры, включая *AveragePrice*, определенную в представлении как *среднее значение цены*.  
    
Если в разделе **Получение данных** выбраны элементы для меры **ProductID** и **AveragePrice**, по этому представлению выполняется запрос на вычисление данных (в примере выше для простоты используется псевдо-SQL, который не соответствует точному синтаксису SAP HANA SQL). После чего все последующие агрегаты, определенные в визуальном элементе, создают сводку результатов этого запроса. Как указано ранее для SQL Server, это касается и импорта, и DirectQuery. В DirectQuery запрос из окна **Получение данных** или **Редактор запросов** будет использоваться в подзапросах в рамках одного запроса, отправленного SAP HANA. Таким образом, нельзя утверждать, что все данные будут считываться перед дальнейшим агрегированием.  

Исходя из указанного выше, при использовании DirectQuery для подключения к SAP HANA нужно учитывать следующие важные моменты:  

* Необходимо уделять внимание последующему агрегированию в визуальных элементах, если меры в SAP HANA неаддитивные (например, не являются простым агрегатом *Sum*, *Min* или *Max*).

* В представлении **Получение данных** или **редакторе запросов**, чтобы получить необходимые данные, должны быть включены только необходимые столбцы, что отражает тот факт, что результатом должен быть подходящий запрос, который можно отправить SAP HANA. Например, если выбраны десятки столбцов, потому что они могут понадобиться для последующих визуальных элементов, то даже простой визуальный элемент для DirectQuery будет означать, что статистический запрос, используемый в подзапросе, содержит десятки столбцов, что снижает производительность.
  
Давайте рассмотрим пример. В следующем примере, если выбрать пять столбцов (**CalendarQuarter**, **Color**, **LastName**, **ProductLine**, **SalesOrderNumber**) в диалоговом окне **получения данных**, а также меру *OrderQuantity*, при дальнейшем создании простой визуализации с Min OrderQuantity будет выполняться указанный ниже запрос SQL для SAP HANA. Затененная часть — это подвыборка с запросом из диалогового окна **получения данных** / **редактора запросов**. Если подзапрос выдаст результат с большим количеством элементов, это может значительно снизить производительность SAP HANA.  

![](media/desktop-directquery-sap-hana/directquery-sap-hana_03.png)

   
Поэтому рекомендуем выбирать в окне **получения данных** или в **редакторе запросов** только необходимые элементы, которые сформируют правильный запрос к SAP HANA.  

## <a name="best-practices"></a>Советы и рекомендации 

При использовании обоих методов подключения к SAP HANA рекомендации для DirectQuery также применимы к SAP HANA (особенно указания, связанные с обеспечением высокой производительности). Эти рекомендации подробно описаны в статье об [использовании DirectQuery в Power BI](desktop-directquery-about.md).
   
## <a name="limitations"></a>Ограничения

В следующем списке перечислены все функции SAP HANA, которые поддерживаются не полностью или работают иначе при использовании Power BI. 

* **Иерархии дочерних элементов родительских элементов.** Иерархии дочерних элементов родительских элементов не отображаются в Power BI.
Это связано с тем, что Power BI обращается к SAP HANA с помощью интерфейса SQL, а к иерархиям родителей-потомков невозможно получить полный доступ через SQL.
* **Другие метаданные иерархии.**  Базовая структура иерархий отображается в Power BI, но некоторые метаданные иерархии (например, метаданные, управляющие поведением неоднородных иерархий) не будут работать.
Это ограничение также связано с интерфейсом SQL.
* **Подключение с помощью SSL**. Вы можете подключиться с использованием импорта и многомерного источника по протоколу SSL, но нельзя подключиться к экземплярам SAP HANA, настроенным для использования SSL в качестве реляционного соединителя.
* **Поддержка для представлений атрибутов**. Power BI может подключаться к представлениям аналитики и вычислений, но не может подключаться напрямую к представлениям атрибутов.
* **Поддержка объектов каталога.** Power BI не может подключаться к объектам каталога.
* **Изменение переменных после публикации.** Переменные SAP HANA невозможно изменить непосредственно в службе Power BI после публикации отчета. 
 
## <a name="known-issues"></a>Известные проблемы 
Ниже перечислены все известные проблемы, которые могут возникнуть при подключении к SAP HANA (DirectQuery) с помощью Power BI. 

* **Проблема с SAP HANA при выполнении запроса счетчиков и других мер.** Если при подключении к представлению аналитики мера счетчиков и другая мера коэффициента включены в одну и ту же визуализацию, из SAP HANA возвращаются неправильные данные. Эта проблема описана в примечании SAP 2128928 (Неожиданный результат при выполнении запроса вычисляемого столбца и счетчика). Мера коэффициента в этом случае будет неправильной. 

* **Несколько столбцов Power BI из одного столбца SAP HANA.** В некоторых представлениях вычислений, где столбец SAP HANA используется в нескольких иерархиях, он отображается как два отдельных атрибута. Это приводит к тому, что в Power BI создаются два столбца.  Эти столбцы скрыты по умолчанию, но все запросы, включающие иерархии или непосредственно столбцы, работают правильно. 
 
## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о DirectQuery см. в следующих статьях:

* [Power BI и DirectQuery](desktop-directquery-about.md)
* [Источники данных, поддерживаемые DirectQuery](desktop-directquery-data-sources.md)
* [Использование DirectQuery и SAP Business Warehouse (BW)](desktop-directquery-sap-bw.md)
* [Локальный шлюз данных](service-gateway-onprem.md)

