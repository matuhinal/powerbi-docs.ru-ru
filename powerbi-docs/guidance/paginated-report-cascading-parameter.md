---
title: Каскадные параметры в отчетах с разбивкой на страницы
description: Руководство по проектированию отчетов с разбивкой на страницы с использованием каскадных параметров.
author: peter-myers
ms.reviewer: asaxton
ms.service: powerbi
ms.subservice: report-builder
ms.topic: conceptual
ms.date: 01/14/2020
ms.author: v-pemyer
ms.openlocfilehash: 90f501b257313c48cbef13517747ff83cd9ea9d1
ms.sourcegitcommit: 7aa0136f93f88516f97ddd8031ccac5d07863b92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/05/2020
ms.locfileid: "78920789"
---
# <a name="use-cascading-parameters-in-paginated-reports"></a>Каскадные параметры в отчетах с разбивкой на страницы

Эта статья предназначена для разработчиков [отчетов Power BI с разбивкой на страницы](../paginated-reports/paginated-reports-report-builder-power-bi.md). Здесь представлены сценарии разработки каскадных параметров. Каскадные параметры представляют собой параметры отчета, имеющие зависимости. Когда пользователь отчета выбирает значение (или значения) параметра, оно используется для установки доступных значений для другого параметра.

> [!NOTE]
> В этой статье не рассматриваются общие сведения о каскадных параметрах и их настройка. Если вы не знакомы с каскадными параметрами, рекомендуем сначала ознакомиться со статьей [Добавление каскадных параметров в отчет (Report Builder и службы SSRS)](/sql/reporting-services/report-design/add-cascading-parameters-to-a-report-report-builder-and-ssrs).

## <a name="design-scenarios"></a>Сценарии разработки

Существует два сценария разработки, требующих использования каскадных параметров. Эти параметры можно эффективно использовать для таких задач:

- фильтрация _больших наборов_ элементов;
- представление _соответствующих_ элементов.

### <a name="example-database"></a>Пример базы данных

Примеры, приведенные в этой статье, основаны на Базе данных SQL Azure. База данных записывает операции продажи и содержит различные таблицы, в которых хранятся данные о торговых посредниках, продуктах и заказах на продажу.

В таблице **Reseller** хранится по одной записи для каждого торгового посредника и содержится множество тысяч записей. В таблице **Reseller** есть следующие столбцы:

- ResellerCode (целое число);
- ResellerName
- Страна или регион
- State-Province
- Город
- Почтовый индекс

Существует также таблица с именем **Sales**. Она содержит записи заказов на продажу и имеет связь по внешнему ключу с таблицей **Reseller** по столбцу **ResellerCode**.

### <a name="example-requirement"></a>Требование для работы с примером

Нужно разработать отчет по профилю торгового посредника. Отчет должен отображать информацию для одного торгового посредника. Не нужно, чтобы пользователь отчета вводил код торгового посредника, так как посредники редко помнят их.

## <a name="filter-large-sets-of-items"></a>Фильтрация больших наборов элементов

Давайте рассмотрим три примера, которые помогут ограничить большие наборы доступных элементов, например записей о торговых посредниках. К ним относятся:

- [фильтрация по связанным столбцам](#filter-by-related-columns);
- [фильтрация по столбцу группирования](#filter-by-a-grouping-column);
- [фильтрация по шаблону поиска](#filter-by-search-pattern).

### <a name="filter-by-related-columns"></a>Фильтрация по связанным столбцам

В этом примере пользователь отчета взаимодействует с пятью параметрами отчета. Он должен выбрать страну или регион, область или край, город и почтовый индекс. Когда эти значения будут указаны, последний пятый параметр выводит список торговых посредников, которые находятся в этом географическом расположении.

![На рисунке показано пять параметров отчета: Country-region, State-province, City, Postal Code и Reseller. Для первых четырех параметров заданы значения, а в списке торговых посредников после фильтрации отображаются только четыре записи.](media/paginated-report-cascading-parameter/filter-by-related-columns-example.png)

Вот как можно разработать каскадные параметры:

1. Создайте пять параметров отчета, упорядоченных в правильной последовательности.
2. Создайте набор данных **CountryRegion**, который получает разные значения страны или региона, используя следующую инструкцию запроса:

    ```sql
    SELECT DISTINCT
      [Country-Region]
    FROM
      [Reseller]
    ORDER BY
      [Country-Region]
    ```

3. Создайте набор данных **StateProvince**, который получает разные значения области или края для выбранной страны или региона, используя следующую инструкцию запроса:

    ```sql
    SELECT DISTINCT
      [State-Province]
    FROM
      [Reseller]
    WHERE
      [Country-Region] = @CountryRegion
    ORDER BY
      [State-Province]
    ```

4. Создайте набор данных **City**, который получает отдельные значения города для выбранных страны или региона и области или края, используя следующую инструкцию запроса:

    ```sql
    SELECT DISTINCT
      [City]
    FROM
      [Reseller]
    WHERE
      [Country-Region] = @CountryRegion
      AND [State-Province] = @StateProvince
    ORDER BY
      [City]
    ```

5. Продолжайте работу с этим шаблоном, чтобы создать набор данных **PostalCode**.
6. Создайте набор данных **Reseller**, чтобы получить список всех торговых посредников для выбранных географических значений, используя следующую инструкцию запроса:

    ```sql
    SELECT
      [ResellerCode],
      [ResellerName]
    FROM
      [Reseller]
    WHERE
      [Country-Region] = @CountryRegion
      AND [State-Province] = @StateProvince
      AND [City] = @City
      AND [PostalCode] = @PostalCode
    ORDER BY
      [ResellerName]
    ```

7. Для каждого набора данных, кроме первого, сопоставьте параметры запроса с соответствующими параметрами отчета.

> [!NOTE]
> Все параметры запроса (с префиксом в виде символа "\@"), приведенные в этих примерах, можно внедрить в инструкции SELECT или передать в хранимые процедуры.
>
> Обычно хранимые процедуры выступают лучшим подходом к разработке, так как их планы запросов кэшируются для более быстрого выполнения и они позволяют при необходимости разработать более сложную логику. Однако в настоящее время они не поддерживаются для реляционных источников данных шлюза (SQL Server, Oracle и Teradata).
>
> Наконец, для поддержки эффективного получения данных следует всегда обеспечивать наличие подходящих индексов. В противном случае параметры отчета могут заполняться слишком долго, а база данных может быть перегружена. Дополнительные сведения об индексировании в SQL Server см. в статье [Руководство по архитектуре и разработке индексов SQL Server](/sql/relational-databases/sql-server-index-design-guide?view=sql-server-2017).

### <a name="filter-by-a-grouping-column"></a>Фильтрация по столбцу группирования

В этом примере пользователь отчета взаимодействует с параметром отчета, чтобы выбрать первую букву названия торгового посредника. Затем второй параметр выводит список торговых посредников, названия которых начинаются с выбранной буквы.

![На рисунке показано два параметра отчета: Group и Reseller. В качестве значения первого параметра задана буква A, а список торговых посредников отфильтрован, и в нем отображается множество записей, которые начинаются с этой буквы.](media/paginated-report-cascading-parameter/filter-by-grouping-column-example.png)

Вот как можно разработать каскадные параметры:

1. Создайте параметры отчета **ReportGroup** и **Reseller**, упорядоченные в правильной последовательности.
2. Создайте набор данных **ReportGroup**, чтобы получить первые буквы, содержащиеся в названиях всех торговых посредников, используя следующую инструкцию запроса:

    ```sql
    SELECT DISTINCT
      LEFT([ResellerName], 1) AS [ReportGroup]
    FROM
      [Reseller]
    ORDER BY
      [ReportGroup]
    ```

3. Создайте набор данных **Reseller**, чтобы получить список всех торговых посредников, названия которых начинаются с выбранной буквы, используя следующую инструкцию запроса:

    ```sql
    SELECT
      [ResellerCode],
      [ResellerName]
    FROM
      [Reseller]
    WHERE
      LEFT([ResellerName], 1) = @ReportGroup
    ORDER BY
      [ResellerName]
    ```

4. Сопоставьте параметр запроса набора данных **Reseller** с соответствующим параметром отчета.

Гораздо эффективнее добавить столбец группирования в таблицу **Reseller**. При сохранении и индексировании она обеспечивает наилучший результат. Дополнительные сведения см. в статье [Specify Computed Columns in a Table](/sql/relational-databases/tables/specify-computed-columns-in-a-table).

```sql
ALTER TABLE [Reseller]
ADD [ReportGroup] AS LEFT([ResellerName], 1) PERSISTED
```

Эта методика может обеспечить большие возможности. Рассмотрим следующий скрипт, который добавляет новый столбец группирования для фильтрации торговых посредников по _предварительно определенным наборам букв_. Он также создает индекс для эффективного получения данных, необходимых для параметров отчета.

```sql
ALTER TABLE [Reseller]
ADD [ReportGroup2] AS CASE
  WHEN [ResellerName] LIKE '[A-C]%' THEN 'A-C'
  WHEN [ResellerName] LIKE '[D-H]%' THEN 'D-H'
  WHEN [ResellerName] LIKE '[I-M]%' THEN 'I-M'
  WHEN [ResellerName] LIKE '[N-S]%' THEN 'N-S'
  WHEN [ResellerName] LIKE '[T-Z]%' THEN 'T-Z'
  ELSE '[Other]'
END PERSISTED
GO

CREATE NONCLUSTERED INDEX [Reseller_ReportGroup2]
ON [Reseller] ([ReportGroup2]) INCLUDE ([ResellerCode], [ResellerName])
GO
```

### <a name="filter-by-search-pattern"></a>Фильтрация по шаблону поиска

В этом примере пользователь отчета взаимодействует с параметром отчета, чтобы ввести шаблон поиска. Затем второй параметр выводит список торговых посредников, названия которых содержат этот шаблон.

![На рисунке показано два параметра отчета: Search и Reseller. В качестве значения первого параметра задан текст red, а список торговых посредников отфильтрован, и в нем отображается несколько записей, содержащих этот текст.](media/paginated-report-cascading-parameter/filter-by-search-pattern-example.png)

Вот как можно разработать каскадные параметры:

1. Создайте параметры отчета **Search** и **Reseller**, упорядоченные в правильной последовательности.
2. Создайте набор данных **Reseller**, чтобы получить список всех торговых посредников, названия которых содержат искомый текст, используя следующую инструкцию запроса:

    ```sql
    SELECT
      [ResellerCode],
      [ResellerName]
    FROM
      [Reseller]
    WHERE
      [ResellerName] LIKE '%' + @Search + '%'
    ORDER BY
      [ResellerName]
    ```

3. Сопоставьте параметр запроса набора данных **Reseller** с соответствующим параметром отчета.

> [!TIP]
> Эту модель можно улучшить, предоставив больший контроль для пользователей отчетов. Они смогут определять собственное значение для сопоставления с шаблоном. Например, при использовании значения поиска red% список торговых посредников отфильтруется для отображения тех, названия которых _начинаются_ с текста red.
>
> Дополнительные сведения см. в статье [USE (Transact-SQL)](/sql/t-sql/language-elements/like-transact-sql?view=sql-server-ver15#using-the--wildcard-character).

Вот как можно позволить пользователям отчета определять собственный шаблон.

```sql
WHERE
  [ResellerName] LIKE @Search
```

Однако многие пользователи, не являющиеся специалистами по базам данных, не знают о подстановочном знаке % (знак процента). Но они знакомы со знаком * (звездочка). Чтобы позволить им использовать этот знак, нужно изменить предложение WHERE.

```sql
WHERE
  [ResellerName] LIKE SUBSTITUTE(@Search, '%', '*')
```

## <a name="present-relevant-items"></a>Представление соответствующих элементов

В этом сценарии можно использовать данные фактов для ограничения доступных значений. Для пользователей отчетов будут показаны элементы, для которых зафиксировано действие.

В этом примере пользователь отчета взаимодействует с тремя параметрами отчета. Первые два устанавливают диапазон дат заказов на продажу. Третий параметр выводит список торговых посредников, заказы которых были созданы в течение этого периода времени.

![На рисунке показано три параметра отчета: Start Order Date, End Order Date и Reseller. Для двух параметров даты задан январь 2020 г., а список торговых посредников отфильтрован, и в нем отображается много записей о торговых посредниках, которые осуществили заказы в течение этого месяца.](media/paginated-report-cascading-parameter/filter-relevant-items-example.png)

Вот как можно разработать каскадные параметры:

1. Создайте параметры отчета **OrderDateStart**, **OrderDateEnd** и **Reseller**, упорядоченные в правильной последовательности.
2. Создайте набор данных **Reseller**, чтобы получить список всех торговых посредников, которые создали заказы в рамках временного периода, используя следующую инструкцию запроса:

    ```sql
    SELECT DISTINCT
      [r].[ResellerCode],
      [r].[ResellerName]
    FROM
      [Reseller] AS [r]
    INNER JOIN [Sales] AS [s]
      ON [s].[ResellerCode] = [r].[ResellerCode]
    WHERE
      [s].[OrderDate] >= @OrderDateStart
      AND [s].[OrderDate] < DATEADD(DAY, 1, @OrderDateEnd)
    ORDER BY
      [r].[ResellerName]
    ```

## <a name="recommendations"></a>Рекомендации

Рекомендуется по возможности создавать отчеты с каскадными параметрами. Это обусловлено тем, что они:

- предоставляют пользователям отчетов интуитивно понятные и полезные возможности;
- являются эффективными, так как они получают небольшие наборы доступных значений.

Обязательно оптимизируйте источники данных таким образом:

- по возможности используйте хранимые процедуры;
- добавляйте соответствующие индексы для эффективного получения данных;
- материализуйте значения столбцов и даже строк, чтобы избежать дорогостоящих оценок во время выполнения запросов.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения, связанные с темой этой статьи, см. в следующих ресурсах.

- [Параметры отчета в Power BI Report Builder](../paginated-reports/report-builder-parameters.md)
- [Добавление каскадных параметров в отчет (Report Builder и службы SSRS)](/sql/reporting-services/report-design/add-cascading-parameters-to-a-report-report-builder-and-ssrs)
- У вас появились вопросы? [Попробуйте задать вопрос в сообществе Power BI.](https://community.powerbi.com/)
- У вас есть предложения? [Идеи по улучшению Power BI](https://ideas.powerbi.com)
