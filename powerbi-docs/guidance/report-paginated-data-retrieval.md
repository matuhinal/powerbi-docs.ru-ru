---
title: Руководство по получению данных для отчетов с разбивкой на страницы
description: Руководство по созданию источников и наборов данных для отчетов Power BI с разбивкой на страницы.
author: peter-myers
ms.reviewer: asaxton
ms.service: powerbi
ms.subservice: report-builder
ms.topic: conceptual
ms.date: 02/16/2020
ms.author: v-pemyer
ms.openlocfilehash: 067171f7ec74beccdb5a312c1cac5bbc6c87541f
ms.sourcegitcommit: 7aa0136f93f88516f97ddd8031ccac5d07863b92
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/05/2020
ms.locfileid: "79377657"
---
# <a name="data-retrieval-guidance-for-paginated-reports"></a>Руководство по получению данных для отчетов с разбивкой на страницы

Эта статья предназначена для разработчиков [отчетов Power BI с разбивкой на страницы](../paginated-reports/paginated-reports-report-builder-power-bi.md). В ней приведены рекомендации по проектированию эффективного получения данных.

## <a name="data-source-types"></a>Типы источников данных

Отчеты с разбивкой на страницы изначально поддерживают как реляционные, так и аналитические источники данных. Эти источники далее подразделяются на облачные и локальные. Для подключения Power BI к локальным источникам данных (размещенным в локальной среде или на виртуальной машине) требуется шлюз данных. К облачным источникам Power BI может подключаться напрямую через Интернет.

Если есть возможность выбрать тип источника данных (например, при создании проекта), мы рекомендуем использовать облачный источник. Отчеты с разбивкой на страницы позволяют подключаться к таким источникам с меньшей сетевой задержкой, особенно если они находятся в том же регионе, что и клиент Power BI. Кроме того, к таким источникам можно подключаться с использованием единого входа. Это означает, что идентификационные данные пользователя отчета могут передаваться в источник данных, что позволяет применять разрешения на уровне строк для каждого пользователя. В настоящее время единый вход не поддерживается для локальных источников данных (поэтому в службах SQL Server Analysis Services разрешения на уровне строк для каждого пользователя не применяются).

> [!NOTE]
> Хотя в настоящее время нет возможности подключаться к локальным базам данных с использованием единого входа, вы все же можете применять разрешения на уровне строк. Для этого в параметр запроса к набору данных передается встроенное поле **UserID**. В источнике данных значения имени участника-пользователя (UPN) должны храниться таким образом, чтобы можно было правильно фильтровать результаты запроса.
>
> Например, предположим, что сведения о каждом продавце хранятся в виде строки в таблице **Продавец**.  В этой таблице есть столбцы для имени участника-пользователя, а также региона продаж продавца. Во время выполнения запроса таблица фильтруется по имени участника-пользователя отчета, а также связывается с фактами продаж с помощью внутреннего соединения. Таким образом запрос эффективно отфильтровывает строки с фактами продаж по региону продаж пользователя отчета.

### <a name="relational-data-sources"></a>Реляционные источники данных

Как правило, реляционные источники данных хорошо подходят для рабочих отчетов, например по счетам на продажу. Они также подходят для отчетов, которые требуют получения очень больших наборов данных (более 10 000 строк). В реляционных источниках данных также могут определяться хранимые процедуры, которые выполняются наборами данных отчета. Хранимые процедуры дают несколько преимуществ:

- Определение параметров
- инкапсуляция программной логики, обеспечивающая более сложную подготовку данных (например, временные таблицы, курсоры или скалярные функции, определяемые пользователем);
- улучшенные возможности поддержки, позволяющие легко обновлять логику хранимых процедур; в некоторых случаях это можно делать, не изменяя отчеты с разбивкой на страницы и не публикуя их повторно (при условии, что имена столбцов и типы данных остаются неизменными);
- повышенная производительность, так как планы выполнения кэшируются для повторного использования;
- повторное использование хранимых процедур в нескольких отчетах.

В Power BI Report Builder можно использовать конструктор реляционных запросов для графического построения инструкции запроса, но только для источников данных Майкрософт.

### <a name="analytic-data-sources"></a>Аналитические источники данных

Аналитические источники данных хорошо подходят как для рабочих, так и для аналитических отчетов. Они могут обеспечивать быстрое получение сводных результатов запросов даже на основе данных очень большого объема. Меры модели и ключевые показатели эффективности могут инкапсулировать сложные бизнес-правила для формирования сводных данных. Однако такие источники данных не подходят для отчетов, которые требуют получения очень больших наборов данных (более 10 000 строк).

В Power BI Report Builder есть два конструктора запросов: конструктор запросов DAX для служб Analysis Services и конструктор запросов многомерных выражений для служб Analysis Services. Их можно использовать для источников наборов данных Power BI или для любой модели служб SQL Server Analysis Services либо Azure Analysis Services — табличной или многомерной.

Мы рекомендуем использовать конструктор запросов DAX, если он полностью удовлетворяет ваши потребности. Если в модели не определены нужные меры, потребуется переключиться в режим запроса. В нем можно настроить инструкцию запроса, добавив выражения (для формирования сводных данных).

Конструктор запросов многомерных выражений требует, чтобы модель включала в себя меры. В нем есть две возможности, не поддерживаемые конструктором запросов DAX. В частности:

- определение вычисляемых элементов на уровне запросов (в многомерных выражениях);
- настройка областей данных для запроса [серверных агрегатов](/sql/reporting-services/report-design/report-builder-functions-aggregate-function) в группах, не являющихся группами сведений. Если в отчете должны быть представлены сводки полуаддитивных или неаддитивных мер (например, результаты вычислений логики операций со временем или уникальные счетчики), то, скорее всего, будет эффективнее использовать серверные агрегаты, чем получать строки с подробными сведениями и формировать сводные данные в отчете.

## <a name="query-result-size"></a>Размер результатов запроса

Как правило, рекомендуется получать только те данные, которые необходимы для отчета. Поэтому не следует получать столбцы или строки, которые не требуются для отчета.

Чтобы ограничить количество строк, следует всегда применять наиболее строгие фильтры и определять агрегатные запросы. Агрегатные запросы группируют и обобщают исходные данные для получения результатов с более высоким уровнем детализации. Например, предположим, что в отчете должна быть представлена сводка по продажам продавцов. Вместо получения всех строк заказов на продажу можно создать запрос к набору данных, который группирует данные по продавцам и суммирует объем продаж для каждой группы.

## <a name="expression-based-fields"></a>Поля на основе выражений

Набор данных отчета можно расширить с помощью полей, основанных на выражениях. Например, если набор данных содержит имена и фамилии клиентов, может потребоваться поле, в котором эти значения объединяются для получения полного имени клиента. Выполнить это вычисление можно двумя способами. Вы можете выбрать один из следующих вариантов.

- Создайте _вычисляемое поле_, которое является полем набора данных на основе выражения.
- Включите выражение непосредственно в запрос к набору данных (используя собственный язык источника данных), чтобы получить обычное поле набора данных.

По возможности рекомендуется использовать второй вариант. Есть две веские причины, по которым лучше включать выражения непосредственно в запрос к набору данных.

- Существует возможность того, что источник данных лучше оптимизирован для вычисления выражений, чем Power BI (особенно в случае реляционных баз данных).
- Производительность отчета повышается, так как Power BI не требуется материализовать вычисляемые поля до преобразования отчета для просмотра. Когда наборы данных получают большое количество строк, вычисляемые поля могут заметно увеличивать время преобразования отчета для просмотра.

## <a name="field-names"></a>Имена полей

При создании набора данных его поля автоматически получают имена столбцов из запроса. Эти имена могут быть не совсем понятны. Кроме того, имена столбцов в исходном запросе могут содержать символы, запрещенные в идентификаторах объектов языка определения отчетов (RDL) (например, пробелы и специальные символы). В этом случае запрещенные символы заменяются на символ подчеркивания (_).

Рекомендуется сначала убедиться в том, что все имена полей понятны, кратки и осмысленны. Если это не так, мы рекомендуем изменить их _перед тем_, как приступать к формированию макета отчета. Это избавит от необходимости внесения изменений в выражения, используемые в макете отчета. Если вы решите переименовать поля после начала работы над макетом отчета, потребуется найти и исправить все нарушенные выражения.

## <a name="filter-vs-parameter"></a>Фильтры и параметры

Скорее всего, макет отчета с разбивкой на страницы будет включать в себя параметры отчета. Параметры отчета часто применяются для фильтрации отчета пользователем. У автора отчета с разбивкой на страницы есть два способа обеспечить фильтрацию отчета. Параметр отчета можно сопоставить с одним из следующих элементов:

- с _фильтром_ набора данных; в этом случае значения параметра отчета используются для фильтрации данных, уже полученных набором данных;
- с _параметром_ набора данных; в этом случае значения параметра отчета включаются в собственный запрос, передаваемый в источник данных.

> [!NOTE]
> Все наборы данных отчета кэшируются для _отдельного сеанса_ и сохраняются в кэше в течение 10 минут _после их последнего использования_. Набор данных может использоваться повторно при отправке новых значений параметров (фильтрации), отрисовке отчета в другом формате или каком-либо взаимодействии с макетом отчета, например переключении видимости или сортировке.

Рассмотрим, например, отчет о продажах с одним параметром отчета для фильтрации по отдельному году. Набор данных получает сведения о продажах за _все годы_. Происходит это потому, что параметр отчета сопоставлен с фильтрами набора данных. В отчете отображаются данные за запрошенный год, то есть подмножество данных из набора данных. Когда пользователь изменяет значение параметра отчета на другой год, а затем просматривает отчет, Power BI не требуется получать данные из источника. Вместо этого применяется другой фильтр к уже кэшированному набору данных. Когда набор данных кэширован, фильтрация может происходить очень быстро.

Теперь рассмотрим другой макет отчета. На этот раз параметр года продаж в отчете сопоставлен с параметром набора данных. В этом случае Power BI включает значение года в собственный запрос и набор данных получает данные только за этот год. Каждый раз, когда пользователь изменяет значение параметра года в отчете, а затем просматривает отчет, набор данных получает новый результат запроса именно для этого года.

Оба подхода позволяют фильтровать данные отчета, и оба могут хорошо подходить в тех или иных случаях. Оптимальный выбор зависит от ожидаемых объемов данных, изменчивости данных и ожидаемого поведения пользователей отчета.

_Фильтрацию набора данных_ рекомендуется использовать, если предполагается, что определенное подмножество строк из набора данных будет использоваться многократно (таким образом экономится время на преобразование для просмотра, так как не нужно получать новые данные). В этой ситуации затраты на получение более крупного набора данных компенсируются его повторным использованием. Такой подход полезен для запросов, выполнение которых занимает много времени. Но учтите, что кэширование больших наборов данных для каждого пользователя может негативно сказаться на производительности и пропускной способности.

_Параметризацию набора данных_ рекомендуется использовать, если вероятность запроса другого подмножества строк из набора данных низкая или если высока вероятность того, что будет фильтроваться большое количество строк из набора данных (кэширование в этом случае неэффективно). Этот подход также целесообразен, если хранилище данных является изменчивым. В этом случае каждое изменение значения параметра отчета будет приводить к получению актуальных данных.

## <a name="non-native-data-sources"></a>Сторонние источники данных

Если необходимо разработать отчет с разбивкой на страницы на основе источника данных, который [не поддерживается такими отчетами напрямую](../paginated-reports/paginated-reports-data-sources.md), можно сначала разработать модель данных Power BI Desktop. Таким образом можно подключаться к более чем 100 [источникам данных Power BI](../power-bi-data-sources.md). После публикации модели в службе Power BI можно разработать отчет с разбивкой на страницы, подключающийся к набору данных Power BI.

## <a name="data-integration"></a>Интеграция данных

Объединять данные из нескольких источников данных можно двумя способами.

- **Объединение наборов данных отчета**. Если источники данных [напрямую поддерживаются отчетами с разбивкой на страницы](../paginated-reports/paginated-reports-data-sources.md), можно создать вычисляемые поля, использующие функцию Report Builder [Lookup](/sql/reporting-services/report-design/report-builder-functions-lookup-function) или [LookupSet](/sql/reporting-services/report-design/report-builder-functions-lookupset-function).
- **Разработка модели Power BI Desktop**. Однако, скорее всего, будет эффективнее разработать модель данных в Power BI Desktop. С помощью Power Query можно объединять запросы на основе любого [поддерживаемого источника данных](../power-bi-data-sources.md). После публикации модели в службе Power BI можно разработать отчет с разбивкой на страницы, подключающийся к набору данных Power BI.

## <a name="sql-server-complex-data-types"></a>Сложные типы данных SQL Server

Так как SQL Server является локальным источником данных, Power BI должен подключаться к нему через шлюз. Однако шлюз не поддерживает получение данных сложных типов. К сложным типам данных относятся встроенные типы, такие как [пространственные типы](/sql/relational-databases/spatial/spatial-data-sql-server) GEOMETRY и GEOGRAPHY, а также [hierarchyid](/sql/t-sql/data-types/hierarchyid-data-type-method-reference). К ним также могут относиться определяемые пользователями типы, которые реализуются с помощью класса сборки в среде CLR Microsoft .NET Framework.

Для отображения пространственных и аналитических данных в визуализации карты требуются пространственные данные SQL Server. Поэтому работать с визуализацией карты, когда источником данных является SQL Server, невозможно. При этом с ней можно работать, если источником данных является База данных SQL Azure, так как Power BI подключается к ней не через шлюз.

## <a name="data-related-images"></a>Связанные с данными изображения

С помощью изображений можно добавлять в макет отчета логотипы или картинки. Если изображения связаны со строками, получаемыми набором данных отчета, возможны два варианта.

- Существует возможность того, что данные изображений также можно получить из источника данных (если они уже хранятся в таблице).
- Если изображения хранятся на веб-сервере, можно использовать динамическое выражение для формирования URL-пути к изображению.

Дополнительные сведения и рекомендации см. в статье [Руководство по использованию изображений в отчетах с разбивкой на страницы](report-paginated-image.md).

## <a name="redundant-data-retrieval"></a>Получение избыточных данных

Отчет может получать избыточные данные. Это может происходить при удалении полей запроса к набору данных или при наличии неиспользуемых наборов данных в отчете. Избегайте таких ситуаций, так как они приводят к лишней нагрузке на источники данных, сеть и ресурсы емкости Power BI.

### <a name="deleted-query-fields"></a>Удаленные поля запроса

На странице **Поля** окна **Свойства набора данных** можно удалять _поля запроса_ к набору данных (поля запроса сопоставляются со столбцами, извлекаемыми запросом к набору данных). Однако Report Builder не удаляет соответствующие столбцы из запроса к набору данных.

Если необходимо удалить поля запроса из набора данных, рекомендуется удалить соответствующие столбцы из самого запроса. Report Builder автоматически удалит все лишние поля запроса. Если вы все же удалили поля запроса, обязательно измените инструкцию запроса к набору данных, удалив соответствующие столбцы.

### <a name="unused-datasets"></a>Неиспользуемые наборы данных

При выполнении отчета оцениваются все наборы данных, даже если они не связаны с объектами отчета. По этой причине перед публикацией отчета обязательно удалите все наборы данных, использовавшиеся в целях тестирования или разработки.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения, связанные с темой этой статьи, см. в следующих ресурсах.

- [Поддерживаемые источники данных для отчетов с разбивкой на страницы Power BI](../paginated-reports/paginated-reports-data-sources.md)
- У вас появились вопросы? [Попробуйте задать вопрос в сообществе Power BI.](https://community.powerbi.com/)
- У вас есть предложения? [Идеи по улучшению Power BI](https://ideas.powerbi.com/)
