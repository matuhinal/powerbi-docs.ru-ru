---
title: Руководство по обеспечению безопасности на уровне строк (RLS) в Power BI Desktop
description: Руководство по обеспечению безопасности на уровне строк (RLS) в моделях данных с помощью Power BI Desktop.
author: peter-myers
ms.reviewer: asaxton
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: conceptual
ms.date: 06/18/2020
ms.author: v-pemyer
ms.openlocfilehash: 308e34e5bf70a9999939c99667075b2e468b4df4
ms.sourcegitcommit: eff98b49e794c7c07670dcfb871f43cb06ed9d3a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/19/2020
ms.locfileid: "85095642"
---
# <a name="row-level-security-rls-guidance-in-power-bi-desktop"></a>Руководство по обеспечению безопасности на уровне строк (RLS) в Power BI Desktop

В этой статье описаны средства моделирования данных, работающие с Power BI Desktop. Здесь также описаны полезные методики разработки для обеспечения безопасности на уровне строк (RLS) в моделях данных.

Важно понимать, как выполняется процесс фильтрации _строк таблицы_ с безопасностью на уровне строк. Ее нельзя настроить для ограничения доступа к объектам модели, включая таблицы, столбцы и меры.

> [!NOTE]
> В этой статье не описывается безопасность RLS и как ее настроить. Дополнительные сведения см. в статье [Ограничение доступа к данным с помощью безопасности на уровне строк (RLS) для Power BI Desktop](../create-reports/desktop-rls.md).
>
> Кроме того, здесь также не приведены сведения о принудительном применении RLS для активных подключений к моделям с внешним размещением с помощью Azure Analysis Services или SQL Server Analysis Services. В таких случаях безопасность на уровне строк будет применяться с помощью Analysis Services. Если Power BI подключается с помощью единого входа (SSO), Analysis Services применит безопасность на уровне строк (если у учетной записи нет привилегий администратора).

## <a name="create-roles"></a>Создание ролей

Вы можете создать несколько ролей. При рассмотрении требований к разрешению для одного пользователя отчета необходимо создать отдельную роль, которая предоставляет все эти разрешения, а не шаблон, в котором пользователь отчета будет членом нескольких ролей. Это связано с тем, что пользователь отчета может сопоставляться с несколькими ролями либо напрямую с помощью учетной записи пользователя, либо косвенно посредством членства в группе безопасности. Множественное сопоставление ролей может привести к непредвиденным результатам.

Если пользователь отчета назначается нескольким ролям, фильтры RLS становятся аддитивными. Это означает, что пользователи отчетов могут видеть строки таблицы, представляющие объединение этих фильтров. Более того, в некоторых случаях невозможно гарантировать, что пользователь отчета не увидит строки в таблице. Таким образом, в отличие от разрешений, применяемых к объектам базы данных SQL Server (и других моделей разрешений), принцип "однажды отказано — всегда отказано" не применяется.

Рассмотрим модель с двумя ролями. Первая роль, именуемая **Workers**, ограничивает доступ ко всем строкам таблицы **Payroll** с помощью следующего выражения правила:

```dax
FALSE()
```

> [!NOTE]
> Правило не возвращает строки таблицы, если выражение имеет значение **false**.

А вторая роль, именуемая **Managers**, предоставляет доступ ко всем строкам таблицы **Payroll** с помощью следующего выражения правила:

```dax
TRUE()
```

Будьте осторожны. Если пользователь отчета сопоставляется с обеими ролями, то он увидит все строки таблицы **Salary**.

## <a name="optimize-rls"></a>Оптимизация RLS

RLS работает путем автоматического применения фильтров к каждому запросу DAX, эти фильтры могут негативно повлиять на производительность запроса. Таким образом, эффективность RLS сводится к хорошему проектированию модели. Важно следовать указаниям по проектированию модели, как это описано в следующих статьях:

- [Общие сведения о схеме типа "звезда" и ее значении в Power BI](star-schema.md)
- Все статьи на данную тему см. в [документации по Power BI](https://docs.microsoft.com/power-bi/guidance/).

Обычно более эффективно применять фильтры RLS к таблицам измерений, а не к таблицам факта, и использовать качественно спроектированные связи для распространения фильтров RLS на другие таблицы модели. Поэтому не следует использовать функцию [LOOKUPVALUE](https://docs.microsoft.com/dax/lookupvalue-function-dax) DAX, если связи модели могут обеспечить тот же результат.

Каждый раз, когда фильтры RLS применяются к таблицам DirectQuery и существуют связи с другими таблицами DirectQuery, необходимо оптимизировать исходную базу данных. Сюда может входить разработка соответствующих индексов или использование сохраненных вычисляемых столбцов. Дополнительные сведения см. в статье [Руководство по использованию модели DirectQuery в Power BI Desktop](directquery-model-guidance.md).

### <a name="measure-rls-impact"></a>Измерение влияния RLS

В Power BI Desktop можно измерять влияние фильтров RLS на производительность с помощью [Анализатора производительности](../create-reports/desktop-performance-analyzer.md). Сначала определите длительность визуальных запросов отчета без применения RLS. Затем на вкладке **Моделирование** ленты используйте команду **Просмотреть как** для применения RLS, а также чтобы определить и сравнить длительность запросов.

## <a name="configure-role-mappings"></a>Настройка сопоставлений ролей

После публикации в Power BI необходимо сопоставлять участников с ролями набора данных. Добавлять участников в роли могут только владельцы набора данных или администраторы рабочей области. Дополнительные сведения см. в разделе [Управление безопасностью в модели](../admin/service-admin-rls.md#manage-security-on-your-model).

Участниками могут быть учетные записи пользователей или группы безопасности. По возможности рекомендуется сопоставлять группы безопасности с ролями набора данных. Этот процесс подразумевает управление членством в группах безопасности в Azure Active Directory. Возможно, он делегирует задачу администраторам сети.

## <a name="validate-roles"></a>Проверка ролей

Проверьте каждую роль и убедитесь, что она правильно фильтрует модель. Это легко сделать с помощью команды **Просмотреть как** на вкладке **Моделирование** ленты.

Если модель содержит динамические правила с использованием функции [USERNAME](https://docs.microsoft.com/dax/username-function-dax) DAX, проверьте ожидаемые _и непредвиденные_ значения. При внедрении содержимого Power BI — в частности, с помощью сценария [Данные принадлежат приложению](../developer/embedded/embedding.md#embedding-for-your-customers) — логика приложения может передавать любое значение в качестве имени пользователя действующего удостоверения. По возможности убедитесь, что случайные или некорректные значения выполняют фильтрацию без возвращения строк.

Рассмотрим пример с использованием Power BI Embedded, если приложение передает должность пользователя в качестве действующего имени пользователя: Это может быть Manager или Worker. Руководители могут видеть все строки, а работники — только те, в которых значение столбца **Type** имеет значение Internal.

Следующее выражение правила определено:

```dax
IF(
    USERNAME() = "Worker",
    [Type] = "Internal",
    TRUE()
)
```

Проблема с этим выражением правила заключается в том, что все значения, за исключением Worker, возвращают _все строки таблицы_. Поэтому случайное значение, например Wrker, непреднамеренно вернет все строки таблицы. Таким образом, безопаснее писать выражение, которое проверяет каждое ожидаемое значение. В следующем улучшенном выражении правила непредвиденное значение приведет к тому, что таблица не будет возвращать строки.

```dax
IF(
    USERNAME() = "Worker",
    [Type] = "Internal",
    IF(
        USERNAME() = "Manager",
        TRUE(),
        FALSE()
    )
)
```

## <a name="design-partial-rls"></a>Разработка частичной RLS

Иногда для вычислений нужны значения без фильтров RLS. Например, для отчета может потребоваться отобразить отношение дохода, полученного для региона продаж пользователя отчета, ко _всему доходу_.

Хотя выражение DAX не может переопределить RLS, в действительности оно даже не может определить, что RLS уже применено. Вы можете использовать сводную таблицу модели. Сводная таблица модели запрашивает и получает значение дохода для всех регионов и не ограничена фильтрами RLS.

Давайте посмотрим, как можно реализовать это требование к разработке. Сначала рассмотрим следующее проектирование модели:

:::image type="content" source="media/rls-guidance/mixed-rls-model.png" alt-text="Изображение схемы модели. Подробное описание приводится в следующем абзаце.":::

Модель состоит из четырех таблиц:

- В таблице **Salesperson** хранится по одной строке для каждого продавца. Она содержит столбец **EmailAddress**, в котором хранится адрес электронной почты каждого продавца. Эта таблица скрыта.
- В таблице **Sales** хранится по одной строке для каждого заказа. Она содержит меру **Revenue % All Region** (% отклонения для всего региона), которая позволяет возвращать отношение дохода, полученного в регионе пользователя отчета, к доходу, полученному по всем регионам.
- В таблице **Date** хранится одна строка на одну дату. Здесь можно выполнять фильтрацию и группирование по году и месяцу.
- **SalesRevenueSummary** является вычисляемой таблицей. В ней хранятся итоговые доходы по каждой дате заказа. Эта таблица скрыта.

Следующее выражение определяет вычисляемую таблицу **SalesRevenueSummary**:

```dax
SalesRevenueSummary =
SUMMARIZECOLUMNS(
    Sales[OrderDate],
    "RevenueAllRegion", SUM(Sales[Revenue])
)
```

> [!NOTE]
> [Таблица агрегирования](../transform-model/desktop-aggregations.md) может обеспечить те же требования к разработке.

Следующее правило RLS применяется к таблице **Salesperson**:

```dax
[EmailAddress] = USERNAME()
```

Каждая из трех связей модели описана в следующей таблице:

|Связь|Описание|
|---------|---------|
|![Конечный блок 1.](media/common/icon-01-red-30x30.png)|Между таблицами **Salesperson** и **Sales** существует связь "Многие ко многим". Правило RLS фильтрует столбец **EmailAddress** скрытой таблицы **Salesperson** с помощью функции [USERNAME](https://docs.microsoft.com/dax/username-function-dax) DAX. Значение столбца **Region** (для пользователя отчета) распространяется на таблицу **Sales**.|
|![Конечный блок 2.](media/common/icon-02-red-30x30.png)|Между таблицами **Date** и **Sales** существует связь "один ко многим".|
|![Конечный блок 3.](media/common/icon-03-red-30x30.png)|Между таблицами **Date** и **SalesRevenueSummary** существует связь "один ко многим".|

Следующее выражение определяет меру **Revenue % All Region** (% отклонения для всего региона):

```dax
Revenue % All Region =
DIVIDE(
    SUM(Sales[Revenue]),
    SUM(SalesRevenueSummary[RevenueAllRegion])
)
```

> [!NOTE]
> Следите за тем, чтобы не раскрывать конфиденциальную информацию. Если в этом примере только два региона, пользователь отчета может вычислить доход для другого региона.

## <a name="avoid-using-rls"></a>Предотвращение использования RLS

Старайтесь не использовать RLS, если в этом есть смысл. При наличии небольшого количества упрощенных правил RLS, которые применяют статические фильтры, рассмотрите возможность публикации нескольких наборов данных. Ни один из наборов данных не определяет роли, так как каждый набор содержит данные для определенной аудитории пользователей отчета, имеющей те же разрешения для доступа к данным. Затем создайте одну рабочую область для каждой аудитории и назначьте ей разрешения для доступа к рабочей области или приложению.

Например, компания только с двумя регионами продаж решила опубликовать набор данных _для каждого региона продаж_ в разных рабочих областях. Наборы данных не применяют RLS. Но они используют [параметры запроса](https://docs.microsoft.com/power-query/power-query-query-parameters) для фильтрации исходных данных. Таким образом, одна и та же модель публикуется в каждой рабочей области. Они имеют разные значения параметров для набора данных. Продавцам назначается доступ только к одной из рабочих областей (или к одному из опубликованных приложений).

С прекращением использования RLS связан ряд преимуществ:

- **Улучшение производительности запросов.** Уменьшение фильтров может привести к улучшению производительности.
- **Небольшие модели.** Хотя это и приводит к увеличению моделей, они имеют меньший размер. Небольшие модели могут повышать скорость реагирования на запросы и обновление данных, особенно если емкость размещения зависима от ресурсов. Кроме того, проще поддерживать размер модели ниже ограничения, накладываемого емкостью. Наконец, проще распределять рабочие нагрузки по разным емкостям, так как вы можете использовать различные емкости для создания или перемещения рабочих областей.
- **Дополнительные функции.** Вы можете использовать функции Power BI, которые не работают с RLS, например [Публикация в Интернете](../collaborate-share/service-publish-to-web.md).

Однако с прекращением использования RLS связан и ряд недостатков:

- **Несколько рабочих областей.** Для каждой аудитории пользователей отчета требуется одна рабочая область. Если приложения публикуются, это также означает, что для каждой аудитории пользователей отчета существует одно приложение.
- **Дублирование содержимого.** Отчеты и панели мониторинга должны быть в каждой рабочей области. Для их настройки и обслуживания требуются дополнительные усилия и время.
- **Пользователи с высоким уровнем привилегий.** Пользователи с высоким уровнем привилегий, которые принадлежат нескольким аудиториям пользователей отчета, не могут просматривать объединенное представление данных. Им нужно открыть несколько отчетов (из разных рабочих областей или приложений).

## <a name="troubleshoot-rls"></a>Устранение неполадок RLS

Если RLS выдает непредвиденные результаты, проверьте наличие следующих проблем:

- Между таблицами модели существуют неправильные связи с точки зрения сопоставлений столбцов и направлений фильтров.
- Неправильно установлено свойство связи **Применить фильтр безопасности в обоих направлениях**. Дополнительные сведения см. в [Руководство по двунаправленным связям](relationships-bidirectional-filtering.md).
- Таблицы не содержат данных.
- В таблицы загружаются неправильные значения.
- Пользователь сопоставлен с несколькими ролями.
- Модель содержит таблицы агрегирования, а правила RLS не согласованно фильтруют агрегаты и сведения. Дополнительные сведения см. в разделе [RLS для агрегатов](../transform-model/desktop-aggregations.md#rls-for-aggregations).

Если конкретный пользователь не видит данные, возможно, что его имя участника-пользователя не сохранено или неправильно введено. Это может произойти внезапно, так как учетная запись пользователя изменилась в результате изменения имени.

> [!TIP]
> В целях тестирования добавьте меру, возвращающую функцию [USERNAME](https://docs.microsoft.com/dax/username-function-dax) DAX. Вы можете присвоить ей имя, например Who Am I. Затем добавьте меру в визуальный элемент карточки в отчете и опубликуйте ее в Power BI.

Если конкретный пользователь может видеть все данные, возможно, он обращается к отчетам напрямую в рабочей области и является владельцем набора данных. RLS применяется только в следующих случаях:

- Отчет открывается в приложении.
- Отчет открывается в рабочей области, а пользователь сопоставляется с [ролью зрителя](../collaborate-share/service-new-workspaces.md#roles-in-the-new-workspaces).

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения, связанные с темой этой статьи, см. в следующих ресурсах.

- [Row-level security (RLS) with Power BI](../admin/service-admin-rls.md) (Безопасность на уровне строк (RLS) в Power BI)
- [Ограничение доступа к данным с помощью безопасности на уровне строк (RLS) для Power BI Desktop](../create-reports/desktop-rls.md)
- [Связи модели в Power BI Desktop](../transform-model/desktop-relationships-understand.md)
- Вопросы? [Задайте их в сообществе Power BI](https://community.powerbi.com/).
- У вас есть предложения? [Идеи по улучшению Power BI](https://ideas.powerbi.com/)
