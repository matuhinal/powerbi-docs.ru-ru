---
title: Рекомендации по производительности Power BI
description: В этой статье представлены рекомендации по созданию быстрых и надежных отчетов в Power BI
author: MarkMcGeeAtAquent
manager: kfile
ms.reviewer: ''
ms.service: powerbi
ms.component: powerbi-service
ms.topic: conceptual
ms.date: 05/18/2018
ms.author: v-mamcge
LocalizationGroup: Reports
ms.openlocfilehash: 78dcd0ac0735bfbb3c22678d6bda1397120360cd
ms.sourcegitcommit: 2a7bbb1fa24a49d2278a90cb0c4be543d7267bda
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/26/2018
ms.locfileid: "34310551"
---
# <a name="power-bi-performance-best-practices"></a>Рекомендации по производительности Power BI 
В этой статье приводятся рекомендации по созданию быстрых и надежных отчетов в Power BI.  

## <a name="use-filters-to-limit-report-visuals-to-display-only-whats-needed"></a>Использование фильтров для отображения только необходимых визуальных элементов в отчете 

Чем больше данных нужно отобразить в визуальном элементе, тем медленнее он загружается. Хотя этот принцип кажется очевидным, о нем можно легко забыть. Например, у вас есть крупный набор данных. На его основе вы создаете отчет с таблицей для таблицы. Чтобы перейти к нужным строкам, пользователи применяют срезы на странице. Как правило, их интересует только несколько десятков строк.

Распространенная ошибка заключается в том, что в представлении по умолчанию не используется фильтрация, то есть отображается более 100 млн строк. Данные для этих строк должны загружаться в память и распаковываться при каждом обновлении. Это приводит к чрезмерной загрузке памяти. Чтобы решить эту проблему, сократите максимальное количество элементов, которые отображаются в таблице, с помощью фильтра "Ведущие N". Максимальное количество элементов может быть значительно больше, чем может понадобиться пользователям, например 10 000. В результате интерфейс пользователя не изменился, но для отчета используется гораздо меньший объем памяти, что соответствующим образом повышает производительность. 
 
Мы настоятельно рекомендуем применять подход, подобный указанному выше, ко всем визуальным элементам в отчетах. Задайте себе вопрос, все ли данные нужны в этом визуальном элементе. Можно ли отфильтровать объем данных, которые отображаются в визуальном элементе, с минимальным влиянием на работу пользователя? Обратите внимание, что таблицы приводят к особенно большим затратам. 
 
## <a name="limit-visuals-on-report-pages"></a>Ограничение визуальных элементов на страницах отчета 
Описанный выше принцип таким же образом применяется к количеству визуальных элементов в определенном отчете. Настоятельно рекомендуем отображать только необходимое количество визуальных элементов в определенном отчете. Детализированные страницы — отличный способ для предоставления дополнительных сведений без большого количества визуальных элементов в отчете.  
 
## <a name="optimize-your-model"></a>Оптимизация модели 
Несколько рекомендаций: 
 
- Неиспользуемые таблицы и столбцы по возможности нужно удалить. 
- Избегайте числа различных объектов в полях с большим количеством элементов, т. е. миллионов уникальных значений.  
- Старайтесь не использовать поля с излишней точностью и большим количеством элементов. Например, можно разделить уникальные значения даты и времени на отдельные столбцы — год, месяц, дата и т. д. Или же, если возможно, используйте округление для полей с высокой точностью, чтобы уменьшить количество элементов (например, 13,29889 -> 13,3). 
- По возможности используйте целочисленные значения вместо строковых. 
- Осторожно применяйте функции DAX, для которых требуется проверять каждую строку в таблице (например, RANKX). В худшем случае для этих функций может потребоваться в несколько раз больше памяти и времени выполнения в связи с линейным увеличением размера таблицы. 
- При подключении к источникам данных с помощью DirectQuery используйте столбцы с индексацией, к которым можно повторно применять фильтры или срезы. Это значительно увеличит скорость реагирования отчета.  
 

Дополнительные рекомендации по оптимизации источников данных для DirectQuery см. в техническом документе [DirectQuery in SQL Server 2016 Analysis Services](https://blogs.msdn.microsoft.com/analysisservices/2017/04/06/directquery-in-sql-server-2016-analysis-services-whitepaper/) (DirectQuery в службах SQL Server 2016 Analysis Services). 
 
## <a name="directquery-and-live-connection-understand-underlying-data-source-performance"></a>Подключение через DirectQuery и динамическое подключение. Сведения о производительности основного источника данных 

При использовании подключения через DirectQuery или динамического подключения, когда пользователь переходит к отчету Power BI, Power BI отправляет запросы к основному источнику данных в режиме реального времени. Если источник данных возвращает запрашиваемые данные, отчет подготавливается к просмотру. В результате производительность отчета в таких случаях в значительной степени зависит от производительности основного источника данных. 
 
При этом важно знать производительность основного источника данных. Для разных источников существуют разные инструменты, которые позволяют получить данные о производительности запросов. Например, для SQL Server и Azure SQL предоставляется хранилище запросов, которое позволяет собирать журналы запросов и статистику времени выполнения. 
 
В качестве практического ориентира при развертывании отчетов Power BI, созданных при подключении через DirectQuery и динамическом подключении, попробуйте сделать то, что будут делать пользователи в Power BI Desktop. Если отчет медленно загружается в Power BI Desktop, он наверняка будет медленно загружаться в службе для пользователей. 
 
## <a name="directquery-best-practices"></a>Рекомендации по работе с DirectQuery 
В разделе ниже описываются общие рекомендации по подключению через DirectQuery.
  
### <a name="db-design-guidance"></a>Рекомендации по проектированию базы данных 
- По возможности принудительно отправляйте вычисляемые столбцы и меры в источник. Чем ближе они к источнику, тем выше производительность. 
- Оптимизируйте. Анализируйте планы выполнения для запросов, добавляйте индексы для часто фильтруемых столбцов и т. д. 

### <a name="modelling-guidance"></a>Рекомендации по моделированию 
- Для начала используйте Power BI Desktop. 
- Избегайте сложных запросов в редакторе запросов. 
- Не используйте фильтрацию относительных дат в редакторе запросов.  
- Поначалу используйте простые меры и усложняйте их постепенно. 
- Избегайте связей в вычисляемых столбцах и столбцах с уникальными идентификаторами. 
- Попробуйте установить флажок "Предполагать целостность данных". Часто это помогает значительно повысить производительность запросов.  

### <a name="general"></a>Общие 
- Сначала примените фильтры. 
- Отключите механизм взаимодействия между визуальными элементами. Это позволит снизить нагрузку запроса при использовании перекрестного выделения. 
- Ограничьте число визуальных элементов и данных для каждого из них, как описано выше. 
- Включение безопасности на уровне строк может существенно повлиять на производительность. Обязательно протестируйте разные роли безопасности на уровне строк, которые пользователи будут принимать. 
- Обратите внимание, что в службе принудительно применяются значения времени ожидания на уровне запроса, чтобы длительно выполняющиеся запросы не могли использовать все ресурсы системы. Если запросы выполняются дольше 225 секунд, время ожидания истечет и отобразится ошибка на уровне визуального элемента. 

## <a name="understanding-dashboards-and-query-caches"></a>Сведения о панелях мониторинга и кэшах запросов 
При загрузке панели мониторинга визуальные элементы, закрепленные на панелях мониторинга, обрабатываются в кэше запросов. А при просмотре отчета запросы к источнику данных выполняются в режиме реального времени — к службе Power BI (в случае импорта) или к указанному вами источнику данных (при подключении через DirectQuery или динамическом подключении).  
 
> [!NOTE]
> Плитки динамических отчетов, закрепленные на панели мониторинга, не обрабатываются кэшем запросов. Вместо этого они функционируют так же, как и отчеты, и отправляют запросы в ядро сервера в режиме реального времени. 
 

Как понятно из названия, получение данных из кэша запросов обеспечивает лучшую и более согласованную производительность, чем при использовании источника данных. Один из способов воспользоваться преимуществами этой возможности — отображать панели мониторинга в качестве первой целевой страницы для пользователей. Закрепите часто используемые и запрашиваемые визуальные элементы на панели мониторинга. Таким образом, панели мониторинга становятся важной "первой линией защиты", что обеспечивает согласованную производительность с меньшей нагрузкой на ресурсы. Пользователи по-прежнему могут переходить к отчетам для просмотра подробных сведений.  
 

Обратите внимание, что при подключении с помощью DirectQuery и динамическом подключении этот кэш запросов обновляется периодически, отправляя запросы к источнику данных. По умолчанию это происходит каждый час, но значение можно настроить в параметрах набора данных. При каждом обновлении кэша запросов будут отправляться запросы к источнику данных. Количество созданных запросов зависит от количества визуальных элементов, закрепленных на панелях мониторинга, которые основаны на этом источнике данных. Обратите внимание: если включена безопасность на уровне строк, запросы создаются для каждого контекста безопасности. Например, если существуют две разные роли, которые присваиваются пользователям, с двумя разными представлениями данных, при обновлении кэша запросов создается два набора запросов. 
 
## <a name="understand-custom-visual-performance"></a>Сведения о производительности настраиваемых визуальных элементов 
Обязательно проверьте настраиваемые визуальные элементы в работе, чтобы обеспечить высокую производительность. Плохо оптимизированные настраиваемые визуальные элементы могут отрицательно повлиять на производительность всего отчета. 
 
## <a name="deep-dive-into-query-performance-with-sql-profiler-and-power-bi-desktop"></a>Подробный обзор производительности запросов с помощью SQL Server Profiler и Power BI Desktop

Если нужно более подробно узнать, какие визуальные элементы требуют больше всего времени и ресурсов, вы можете подключить SQL Server Profiler к Power BI Desktop, чтобы получить полное представление о производительности запросов.

> [!NOTE]
> Power BI Desktop поддерживает подключение к порту диагностики. Этот порт обеспечивает подключение других инструментов для выполнения трассировки в целях диагностики. *Внесение в модель изменений не поддерживается! Изменения модели могут привести к повреждению и потере данных.*

Следуйте этим инструкциям:
  
1. **Установите SQL Server Profiler и запустите Power BI Desktop.** 

   SQL Server Profiler предоставляется в составе SQL Server Management Studio. 
 
2. **Определите, какой порт используется для Power BI Desktop.** 

   Запустите командную строку или PowerShell с правами администратора и воспользуйтесь программой netstat, чтобы узнать, какой порт Power BI Desktop использует для анализа.

   `> netstat -b -n` 

   В результате вы получите список приложений и открытых для них портов, например:  

   TCP    [::1]:55786            [::1]:55830            ESTABLISHED 

   [msmdsrv.exe] 

   Найдите порт, используемый файлом msmdsrv.exe, и запишите его для дальнейшего использования. В этом случае можно использовать порт 55786. 
3.  **Подключите SQL Server Profiler к Power BI Desktop.** 

   - Запустите SQL Server Profiler из меню **Пуск**. 
   - Последовательно выберите **Файл** > **Создать трассировку**. 
   - Для типа сервера укажите Analysis Services. 
   - Для имени сервера введите localhost:[определенный выше номер порта]. 
   - На следующем экране выберите **Запустить**. 
   - Теперь интерфейс SQL Server Profiler подключен и активно профилирует запросы, которые отправляются из Power BI Desktop. 
   - Во время выполнения запросов вы можете увидеть их длительность и время ЦП. На основе этих сведений можно определить, какие запросы ограничивают производительность.  

С помощью SQL Server Profiler можно определить, какие запросы занимают больше всего времени ЦП, что в свою очередь, может снижать производительность. Следовательно, визуальные элементы, которые выполняют эти запросы, должны быть предметом непрерывной оптимизации. 

## <a name="gateway-best-practices"></a>Рекомендации по использованию шлюза 

Локальный шлюз данных — это эффективный инструмент для подключения службы Power BI к локальному источнику данных. Но в то же время при непродуманном планировании он может стать фактором, снижающим производительность отчетов. Это особенно касается наборов данных, подключаемых через DirectQuery или динамическое подключение, для которых все запросы и ответы на них передаются через шлюз. Ниже приведены рекомендации по обеспечению высокой производительности для шлюзов: 
 
- **Используйте режим предприятия** вместо персонального режима. 
- **Рекомендуемые характеристики оборудования для шлюза:** 8 ядер ЦП, 16 ГБ ОЗУ. 
- **Настройте мониторинг.** Настройте мониторинг производительности на компьютере со шлюзом, чтобы следить, не перегружен ли шлюз и не влияет ли он на производительность. Дополнительные сведения см. в статье [Устранение неполадок локального шлюза данных](service-gateway-onprem-tshoot.md).
- **Используйте вертикальное и горизонтальное масштабирование.** Если шлюз на самом деле становится фактором, снижающим производительность, выполните вертикальное масштабирование (переместите шлюз на более мощный компьютер с большим числом ядер ЦП и объемом памяти) или горизонтальное масштабирование (например, распределите наборы данных по разным шлюзам). 
- **Отделите задачи импорта от DirectQuery.** При горизонтальном масштабировании попробуйте отделить шлюзы, которые отвечают за импорт, от тех, которые отвечают за DirectQuery. 
 
## <a name="network-latency"></a>Задержка в сети 
Задержка в сети может повлиять на производительность отчета, увеличив время, необходимое для передачи запросов в службу Power BI и для доставки ответов. Клиентам в Power BI назначаются определенные регионы. Чтобы узнать домашний регион клиента, перейдите на сайт powerbi.com и щелкните символ **?** в правом верхнем углу, а затем выберите **О Power BI**. Если пользователи получают доступ к службе Power BI из клиента, их запросы всегда перенаправляется в этот регион. Когда запросы будут переданы в службу Power BI, служба может отправить дополнительные запросы, например к основному источнику данных или шлюзу, на что также может повлиять задержка в сети. 

Такие инструменты, как [Azure Speed Test](http://azurespeedtest.azurewebsites.net/), могут определить задержку в сети между клиентом и регионом Azure. В большинстве случаев, чтобы свести к минимуму влияние задержки в сети, старайтесь размещать источники данных, шлюзы и кластер Power BI как можно ближе друг к другу. Если задержка в сети представляет проблему, можете попробовать расположить шлюзы и источники данных ближе к кластеру Power BI, разместив их на виртуальных машинах. 

Чтобы снизить задержку в сети, используйте службу [Azure ExpressRoute](https://azure.microsoft.com/services/expressroute/), которая позволяет создавать быстрые, более надежные сетевые подключения между клиентами и центрами обработки данных Azure. 

## <a name="next-steps"></a>Дальнейшие действия
- [Planning a Power BI Enterprise Deployment](https://aka.ms/pbienterprisedeploy) (Планирование развертывания Power BI Enterprise) со всесторонними рекомендациями по крупномасштабному развертыванию Power BI. 
- [DirectQuery в службах SQL Server 2016 Analysis Services](https://blogs.msdn.microsoft.com/analysisservices/2017/04/06/directquery-in-sql-server-2016-analysis-services-whitepaper/) 
- [[YouTube] Building Fast and Reliable Reports in Power BI](https://www.youtube.com/watch?v=GhiJABR7XX0) (Создание быстрых и надежных отчетов в Power BI). 
- [[YouTube] Power BI Enterprise Deployments](https://www.youtube.com/watch?v=K-zEWICvICM) (Корпоративные развертывания Power BI).  
 
 
