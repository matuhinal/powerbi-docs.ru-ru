---
title: Обновление данных в Power BI
description: Эта статья описывает функции обновления данных в Power BI и их зависимости на концептуальном уровне.
author: davidiseminger
ms.reviewer: kayu
ms.service: powerbi
ms.subservice: powerbi-service
ms.topic: conceptual
ms.date: 03/26/2020
ms.author: davidi
LocalizationGroup: Data refresh
ms.openlocfilehash: e51361d910c558824f33fb9ed00f6332aa3bba07
ms.sourcegitcommit: b2cb0b02bdc451bf11a92a68f2c4d560a811f563
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/16/2020
ms.locfileid: "81440039"
---
# <a name="data-refresh-in-power-bi"></a>Обновление данных в Power BI

Power BI позволяет быстро перейти от данных к аналитическим сведениям и затем к действиям, однако вам нужно обеспечить актуальность данных в отчетах и панелях мониторинга Power BI. Понимание того, как обновить данные, часто является критически важным для получения точных результатов.

Эта статья описывает функции обновления данных в Power BI и их зависимости на концептуальном уровне. Она также содержит рекомендации и советы, помогающие избежать распространенных проблем при обновлении. Этот материал составляет основу, помогающую вам понять принципы обновления данных. Конкретные пошаговые инструкции по настройке обновления данных см. в учебниках и практических руководствах, указанных в разделе "Дальнейшие действия" в конце этой статьи.

## <a name="understanding-data-refresh"></a>Общие сведения об обновлении данных

Когда вы обновляете данные, Power BI нужно запросить базовые источники данных, возможно, загрузить исходные данные в набор данных, а затем обновить все визуализации в отчетах или панелях мониторинга, основанных на обновленном наборе данных. Весь процесс состоит из нескольких этапов, которые зависят от режимов хранения в ваших наборах данных, как описано в следующих разделах.

Чтобы понять, как Power BI обновляет ваши наборы данных, отчеты и панели мониторинга, необходимо иметь представление о следующих понятиях:

- **Режимы хранения и типы наборов данных**: режимы хранения и типы наборов данных, поддерживаемые Power BI, имеют различные требования к обновлению. Вы можете выбирать между повторным импортом данных в Power BI, чтобы просмотреть внесенные изменения, и выполнением запроса к данным прямо в источнике.
- **Типы обновления в Power BI**: вне зависимости от особенностей набора данных знакомство с различными типами обновления может помочь вам понять, на что Power BI может тратить время в течение операции обновления. В сочетании с особенностями режима хранения это позволяет понять, что именно Power BI делает, когда вы выбираете команду **Обновить сейчас** для набора данных.

### <a name="storage-modes-and-dataset-types"></a>Режимы хранения и типы наборов данных

Набор данных Power BI может работать в одном из следующих режимов для доступа к данным из различных источников. Дополнительные сведения см. в статье [Режим хранения в Power BI Desktop](desktop-storage-mode.md).

- Режим импорта
- Режим DirectQuery
- Режим LiveConnect
- Режим принудительной отправки

На следующей схеме показаны различные потоки данных с учетом режима хранения. Наиболее значимым является то, что только наборы данных с режимом импорта требуют обновление источника данных. Эта потребность вызвана тем, что только набор данных этого типа импортирует данные из своих источников данных, и эти импортированные данные могут обновляться как на регулярной основе, так и по необходимости. Наборы данных DirectQuery и наборы данных в режиме LiveConnect в Analysis Services не импортируют данные; они запрашивают базовый источник данных при каждом взаимодействии с пользователем. Наборы данных в режиме принудительной отправки не обращаются к источникам данных напрямую, но ожидают, что вы отправите данные в Power BI. Требования к обновлению наборов данных зависят от режима хранения и типа набора данных.

![Режимы хранения и типы наборов данных](media/refresh-data/storage-modes-dataset-types-diagram.png)

#### <a name="datasets-in-import-mode"></a>Наборы данных в режиме импорта

Power BI импортирует данные из исходных источников данных в набор данных. Запросы к отчетам и панелям мониторинга Power BI, отправленные для набора данных, возвращают результаты из импортированных таблиц и столбцов. Такой набор данных можно рассматривать как копию на определенный момент времени. Так как Power BI копирует данные, вам нужно обновить набор данных, чтобы получить изменения из базовых источников данных.

Так как Power BI кэширует данные, наборы данных в режиме импорта могут достигать значительного размера. Сведения о максимальных размерах наборов данных для емкости см. в таблице ниже. Старайтесь использовать наборы данных значительно меньше максимального размера, чтобы избежать проблем с обновлением, которые могут возникнуть, если при этой операции наборам данных потребуется объем ресурсов, превышающий максимальное доступное значение.

| Тип емкости | Максимальный размер набора данных |
| --- | --- |
| Общая, A1, A2 и A3 | 1 ГБ |
| A4 или P1 | 3 ГБ |
| A5 или P2 | 6 ГБ |
| A6 или P3 | 10 ГБ |
| | |

#### <a name="datasets-in-directqueryliveconnect-mode"></a>Наборы данных в режиме DirectQuery/LiveConnect

Power BI не импортирует данные через подключения, работающие в режиме DirectQuery/LiveConnect. Вместо этого набор данных возвращает результаты из базового источника данных, когда отчет или панель мониторинга выполняют запрос к этому набору данных. Power BI преобразует и перенаправляет запросы к источнику данных.

Хотя режимы DirectQuery и LiveConnect похожи тем, что Power BI перенаправляет запросы в источник, важно отметить, что в режиме LiveConnect службе Power BI необязательно преобразовывать запросы. Запросы направляются непосредственно экземпляру Analysis Services, где размещена база данных, не используя ресурсы общей емкости и емкости Premium.

Так как Power BI не импортирует данные, вам не нужно выполнять обновление данных. Однако Power BI по-прежнему выполняет обновления плиток и, возможно, отчетов, как описано в следующем разделе о типах обновления. Плитка — это визуальный элемент отчета, закрепленный на панели мониторинга, а обновление плиток панели мониторинга выполняется каждый час, чтобы они отображали актуальные результаты. Вы можете изменить расписание в параметрах набора данных, как показано на снимке экрана ниже, или принудительно обновить панель мониторинга вручную с помощью параметра **Обновить сейчас**.

![Расписание обновления](media/refresh-data/refresh-schedule.png)

> [!NOTE]
> Раздел **Запланированное обновление кэша** на вкладке **Наборы данных** недоступен для наборов данных в режиме импорта. Этим наборам данных не нужно отдельное обновление плиток, так как Power BI автоматически обновляет плитки при каждом обновлении данных, выполняемом по расписанию или по запросу.

#### <a name="push-datasets"></a>наборы данных рush-уведомлений;

Наборы данных с принудительной отправкой не содержат формальное определение источника данных, поэтому для них не требуется выполнять обновление данных в Power BI. Вы можете обновить их, отправив свои данные в набор данных через внешнюю службу или процесс, например Azure Stream Analytics. Это распространенный подход для аналитики в реальном времени с использованием Power BI. Power BI по-прежнему выполняет обновления кэша для любых плиток, используемых поверх набора данных с принудительной отправкой. Подробное пошаговое руководство см. в статье [Учебник. Stream Analytics и Power BI: панель мониторинга аналитики в реальном времени для потоковой передачи данных](/azure/stream-analytics/stream-analytics-power-bi-dashboard).

> [!NOTE]
> Режим принудительной отправки имеет несколько ограничений, которые описаны в статье [Ограничения REST API Power BI](developer/automation/api-rest-api-limitations.md).

### <a name="power-bi-refresh-types"></a>Типы обновления в Power BI

Операция обновления Power BI может состоять из нескольких типов обновления, включая обновление данных, обновление OneDrive, обновление кэшей запросов, обновление плиток и обновление визуальных элементов отчетов. Хотя Power BI автоматически определяет необходимые действия обновления для заданного набора данных, вы должны знать, как именно они влияют на сложность и длительность операции обновления. Краткие сведения приведены в таблице ниже.

| Режим хранения | Обновление данных | Обновление OneDrive | Кэши запросов | Обновление плитки | Визуальные элементы отчетов |
| --- | --- | --- | --- | --- | --- |
| Импорт | По расписанию и по запросу | Да, для подключенных наборов данных | Если включено в емкости Premium | Автоматически и по запросу | Нет |
| DirectQuery | Неприменимо | Да, для подключенных наборов данных | Если включено в емкости Premium | Автоматически и по запросу | Нет |
| LiveConnect | Неприменимо | Да, для подключенных наборов данных | Если включено в емкости Premium | Автоматически и по запросу | Да |
| Отправка | Неприменимо | Неприменимо | Нецелесообразно | Автоматически и по запросу | Нет |
| | | | | | |

#### <a name="data-refresh"></a>Обновление данных

Для пользователей Power BI обновление данных обычно означает импорт данных из исходных источников данных в набор данных по расписанию или по запросу. Ежедневно вы можете выполнять несколько обновлений набора данных, что может пригодиться, если базовый источник данных часто изменяется. Для наборов данных в общей емкости Power BI допускает до восьми ежедневных обновлений. Если набор данных находится в емкости Premium, можно запланировать в параметрах набора данных до 48 обновлений в день. Дополнительные сведения см. в разделе [Настройка запланированного обновления](#configure-scheduled-refresh) этой статьи. Наборы данных в емкости Premium с [конечной точкой XMLA](service-premium-connect-tools.md) включены для чтения и записи и поддерживают неограниченное количество операций обновления при программной настройке с помощью TMSL или PowerShell.

Важно также упомянуть, что ограничение ежедневного обновления общей емкости применяется для обновлений как по расписанию, так и с помощью API. Вы можете также активировать обновление по запросу, выбрав команду **Обновить сейчас** в меню набора данных, как показано на снимке экрана ниже. Обновления по запросу не включены в ограничение на обновление. Обратите также внимание, что наборы данных в емкости Premium не имеют ограничений на обновления API. Если вы хотите создать собственное решение для обновления с помощью REST API в Power BI, см. статью [Наборы данных — обновление набора данных](/rest/api/power-bi/datasets/refreshdataset).

![Обновить сейчас](media/refresh-data/refresh-now.png)

> [!NOTE]
> Обновления данных в общей емкости должны быть выполнены менее чем за 2 часа. Если для обновления наборов данных требуется больше времени, рекомендуется переместить такой набор данных в емкость Premium. В Premium максимальная продолжительность обновления равна 5 часам.

#### <a name="onedrive-refresh"></a>Обновление OneDrive

Если вы создали наборы данных и отчеты на основе файла Power BI Desktop, книги Excel или файла с разделителями-запятыми (CSV) в OneDrive или SharePoint Online, Power BI выполняет другой тип обновления, известный как обновление OneDrive. Дополнительные сведения см. в статье [Получение данных из файлов в Power BI](service-get-data-from-files.md).

В отличие от обновления набора данных, где Power BI импортирует данные из источника данных в набор данных, обновление OneDrive синхронизирует наборы данных и отчеты с их исходными файлами. По умолчанию Power BI каждый час проверяет, требуется ли синхронизация для набора данных, подключенного к файлу в OneDrive или SharePoint Online.

> [!IMPORTANT]
> Будьте внимательны при обработке управления файлами в OneDrive. При задании файла OneDrive в качестве источника данных Power BI ссылается на идентификатор элемента файла при выполнении обновления, что может вызвать проблемы в некоторых сценариях. Рассмотрим ситуацию, когда имеется главный файл _А_ и его рабочая копия _Б_ и вы настраиваете обновление OneDrive для файла Б. Если затем _скопировать_ файл А в файл Б, операция копирования удаляет старый файл Б и создает новый файл Б с другим идентификатором элемента, что нарушает обновление OneDrive. Вместо этого следует отправить и заменить файл Б, который сохраняет тот же идентификатор элемента.

Вы можете переместить файл в другое расположение (например, с помощью перетаскивания), при этом обновление продолжит работать, так как средству PBI по-прежнему известен идентификатор файла. Однако при копировании этого файла в другое расположение создается новый экземпляр файла и новый идентификатор файла. Поэтому ссылка на файл Power BI больше не действует и обновление завершится со сбоем.

Чтобы просмотреть прошлые циклы синхронизации, перейдите на вкладку OneDrive в журнале обновлений. На следующем рисунке показан завершенный цикл синхронизации для примера набора данных.

![Журнал обновлений](media/refresh-data/refresh-history.png)

Как показано на снимке экрана выше, Power BI идентифицировал это обновление OneDrive как **запланированное** обновление, однако невозможно настроить интервал обновления. Деактивировать обновление OneDrive можно только в параметрах набора данных. Деактивация обновления удобна в том случае, если вы не хотите, чтобы наборы данных и отчеты в Power BI автоматически получали изменения из исходных файлов.

Обратите внимание, что на этой странице параметров набора данных отображаются только разделы **Учетные данные OneDrive** и **Обновление OneDrive**, если набор данных подключен к файлу в OneDrive или SharePoint Online, как показано на снимке экрана ниже. Для наборов данных, которые не подключены к исходному файлу в OneDrive или SharePoint Online, эти разделы не отображаются.

![Учетные данные OneDrive и обновление OneDrive](media/refresh-data/onedrive-credentials-refresh.png)

Если вы отключили обновление OneDrive для набора данных, ваш набор данных все равно можно синхронизировать по запросу, выбрав **Обновить сейчас** в меню набора данных. В рамках этого обновления по запросу Power BI проверяет, является ли исходный файл в OneDrive или SharePoint Online новее, чем набор данных в Power BI, и синхронизирует набор данных, если это так. **Журнал обновлений** перечисляет эти действия как обновления по запросу на вкладке **OneDrive**.

Помните, что при обновлении OneDrive данные из исходных источников данных не извлекаются. Обновление OneDrive просто обновляет ресурсы в Power BI с использованием метаданных и данных из файла PBIX, XLSX или CSV, как показано на схеме ниже. Чтобы убедиться, что набор данных содержит самые актуальные данные из источников данных, Power BI также активирует обновление данных в рамках обновления по запросу. Это можно проверить в окне **Журнал обновлений**, переключившись на вкладку **По расписанию**.

![Схема обновления OneDrive](media/refresh-data/onedrive-refresh-diagram.png)

Если вы оставляете обновление OneDrive включенным для набора данных, подключенного к OneDrive или SharePoint Online, и хотите выполнять обновление данных по расписанию, обязательно настройте расписание так, чтобы служба Power BI выполняла обновление данных после обновления OneDrive. Например, если вы создали собственную службу или собственный процесс для обновления исходного файла в OneDrive или SharePoint Online каждую ночь в 1:00, можно настроить запланированное обновление в 2:30, чтобы оставить Power BI достаточно времени для завершения обновления OneDrive, прежде чем начинать обновление данных.

#### <a name="refresh-of-query-caches"></a>Обновление кэшей запросов

Если ваш набор данных находится в емкости Premium, вы можете повысить производительность связанных отчетов и панелей мониторинга, включив кэширование запросов, как показано на снимке экрана ниже. Кэширование запросов указывает емкости Premium сохранять результаты запросов в локальной службе кэширования, чтобы их вычислением не занимался первоначальный источник данных. Дополнительные сведения см. в разделе [Кэширование запросов в Power BI Premium](power-bi-query-caching.md).

![Кэширование запросов](media/refresh-data/query-caching.png)

Однако после обновления данных ранее кэшированные результаты запросов становятся недействительными. Power BI удаляет эти кэшированные результаты и создает их заново. По этой причине кэширование запросов может не оказывать сильного влияния на отчеты и панели мониторинга, связанные с наборами данных, которые очень часто обновляются, например 48 раз в день.

#### <a name="tile-refresh"></a>Обновление плитки

Power BI хранит кэш для каждого визуального элемента на панелях мониторинга и с упреждением обновляет кэши плиток при изменении данных. Другими словами, обновление плиток автоматически выполняется после обновления данных. Это справедливо для операций обновления как по расписанию, так и по запросу. Можно также принудительно обновить плитку, щелкнув **Дополнительные параметры** (…) в правом верхнем углу панели мониторинга и выбрав команду **Обновить плитки панелей мониторинга**.

![Обновить плитки информационных панелей](media/refresh-data/refresh-dashboard-tiles.png)

Так как это происходит автоматически, вы можете рассматривать обновление плиток как неотъемлемую часть обновления данных. Помимо прочего, можно заметить, что длительность обновления увеличивается с ростом числа плиток. Обновление плиток может подразумевать значительные затраты.

По умолчанию Power BI хранит отдельный кэш для каждой плитки, но если вы используете динамическую безопасность для ограничения доступа к данным на основе ролей пользователей, как описано в статье [Безопасность на уровне строк (RLS) в Power BI](service-admin-rls.md), то Power BI требуется хранить кэш для каждой роли и каждой плитки. Число кэшей плиток увеличивается пропорционально числу ролей.

Ситуация может еще больше осложниться, если набор данных использует активное подключение к модели данных Analysis Services с RLS, как указано в учебнике [Динамическая безопасность на уровне строк при использовании табличной модели Analysis Services](desktop-tutorial-row-level-security-onprem-ssas-tabular.md). В этом случае Power BI приходится хранить и обновлять кэш для каждой плитки и каждого пользователя, который когда-либо просматривал панель мониторинга. Нередко та часть операции обновления данных, которая связана с обновлением плиток, занимает значительно больше времени, чем получение данных из источника. Дополнительные сведения об обновлении плиток см. в статье [Устранение неполадок с плитками](refresh-troubleshooting-tile-errors.md).

#### <a name="refresh-of-report-visuals"></a>Обновление визуальных элементов отчетов

Этот процесс обновления менее важен, так как он применяется только для активных подключений к Analysis Services. Для этих подключений Power BI кэширует последнее состояние визуальных элементов отчетов, чтобы при повторном просмотре вами отчета Power BI не приходилось запрашивать табличную модель Analysis Services. При взаимодействии с отчетом, например при изменении фильтра отчета, Power BI автоматически запрашивает табличную модель и обновляет визуальные элементы отчетов. Если вы подозреваете, что отчет отображает устаревшие данные, можно также нажать кнопку "Обновить" для отчета, чтобы активировать обновление всех визуальных элементов отчетов, как показано на снимке экрана ниже.

![Обновление визуальных элементов отчетов](media/refresh-data/refresh-report-visuals.png)

## <a name="review-data-infrastructure-dependencies"></a>Изучение зависимостей инфраструктуры данных

Независимо от режимов хранения, обновление данных может быть выполнено только при наличии доступа к базовым источникам данных. Существует три основных сценария доступа к данным:

- Набор данных использует источники данных, которые находятся в локальной среде.
- Набор данных использует источники данных в облаке.
- Набор данных использует данные как из локальных, так и из облачных источников.

### <a name="connecting-to-on-premises-data-sources"></a>Подключение к локальным источникам данных

Если набор данных использует источник данных, к которому Power BI не может обратиться через прямое сетевое соединение, прежде чем включить расписание обновления или выполнить обновление данных по запросу, нужно настроить подключения шлюза для этого набора данных. Дополнительные сведения о шлюзах данных и их работе см. в статье [Что такое локальные шлюзы данных?](service-gateway-onprem.md).

Вам доступны следующие варианты:

- Выбор корпоративного шлюза данных с требуемым определением источника данных
- Развертывание персонального шлюза данных

> [!NOTE]
> Список типов источников данных, которым требуется шлюз данных, см. в статье [Управление источником данных — импорт или запланированное обновление](service-gateway-enterprise-manage-scheduled-refresh.md).

#### <a name="using-an-enterprise-data-gateway"></a>Использование корпоративного шлюза данных

Корпорация Майкрософт рекомендует использовать корпоративный шлюз данных вместо персонального шлюза, чтобы подключить набор данных к локальному источнику данных. Убедитесь, что шлюз настроен правильно, то есть для него установлены последние обновления и заданы все необходимые определения источников данных. Определение источника данных предоставляет Power BI сведения о заданном источнике, включая конечные точки подключения, режим проверки подлинности и учетные данные. Дополнительные сведения об управлении источниками данных в шлюзе см. в статье [Управление источником данных — импорт или запланированное обновление](service-gateway-enterprise-manage-scheduled-refresh.md).

Подключение набора данных к корпоративному шлюзу является относительно простой процедурой, если вы являетесь администратором шлюза. Обладая разрешениями администратора, вы можете немедленно обновить шлюз и добавить отсутствующие источники данных, если это необходимо. Фактически вы можете добавить отсутствующий источник данных в шлюз прямо на странице параметров набора данных. Разверните выключатель для просмотра источников данных и выберите ссылку **Добавить на шлюз**, как показано на снимке экрана ниже. С другой стороны, если вы не являетесь администратором шлюза, попросите администратора шлюза добавить нужное определение источника данных.

> [!NOTE]
> Только администраторы шлюза могут добавлять источники данных в шлюз. Кроме того, убедитесь, что администратор шлюза добавил вашу учетную запись пользователя в список пользователей с разрешениями на использование источника данных. На странице параметров набора данных можно выбрать только корпоративный шлюз с совпадающим источником данных, на использование которого у вас есть разрешение.

![Добавить на шлюз](media/refresh-data/add-to-gateway.png)

Убедитесь, что c источником данных сопоставляется правильное определение источника данных. Как показано на приведенном выше снимке экрана, администраторы шлюза могут создавать на одном шлюзе несколько определений, подключающихся к одному источнику данных с разными учетными данными. В приведенном примере владелец набора данных из отдела продаж выбрал определение источника данных AdventureWorksProducts-Sales, а владелец набора данных из службы поддержки сопоставил набор данных с определением источника данных AdventureWorksProducts-Support. Если имена определений источников данных не являются интуитивно понятными, обратитесь к администратору шлюза, чтобы уточнить, какое определение следует выбрать.

> [!NOTE]
> Набор данных может использовать только одно подключение к шлюзу. Другими словами, он не может обращаться к локальным источникам данных через несколько подключений шлюза. Соответственно, вам нужно добавить все необходимые определения источников определения на один шлюз.

#### <a name="deploying-a-personal-data-gateway"></a>Развертывание персонального шлюза данных

Если у вас нет доступа к корпоративному шлюзу данных и вы являетесь единственным пользователем, управляющим наборами данных, то вам не требуется использовать наборы данных совместно с другими пользователями, поэтому вы можете развернуть шлюз в персональном режиме. В разделе **Подключение шлюза** в области **️У вас не установлены персональные шлюзы** выберите **Установить**. Персональный шлюз данных имеет несколько ограничений, которые описаны в статье [Локальный шлюз данных (персональный режим)](service-gateway-personal-mode.md).

В отличие от корпоративного шлюза данных, вам не нужно добавлять определения источников данных на персональный шлюз. Вместо этого вы можете управлять конфигурацией источников данных с помощью раздела **Учетные данные источников данных** в параметрах набора данных, как показано на снимке экрана ниже.

![Настройка учетных данных источника данных для шлюза](media/refresh-data/configure-data-source-credentials-gateway.png)

> [!NOTE]
> Персональный шлюз данных не поддерживает наборы данных в режиме DirectQuery/LiveConnect. На странице параметров набора данных вам может быть предложено установить его, но при наличии лишь персонального шлюза настроить подключение шлюза невозможно. Для поддержки этих типов наборов данных вам нужен корпоративный шлюз данных.

### <a name="accessing-cloud-data-sources"></a>Обращение к облачным источникам данных

Наборам данных, использующим облачные источники данных, такие как база данных SQL Azure, шлюз данных не требуется, если Power BI может установить прямое сетевое подключение к источнику. Соответственно, вы можете управлять конфигурацией этих источников данных с помощью раздела **Учетные данные источников данных** в параметрах набора данных. Как показано на снимке экрана ниже, настраивать подключение шлюза не требуется.

![Настройка учетных данных источника данных без шлюза](media/refresh-data/configure-data-source-credentials.png)

### <a name="accessing-on-premises-and-cloud-sources-in-the-same-source-query"></a>Обращение к локальным и облачным источникам данных в рамках одного исходного запроса

Набор данных может получать данные из нескольких источников, которые могут находиться в локальной среде или облаке. Однако, как было указано ранее, набор данных может использовать только одно подключение к шлюзу. Хотя облачным источникам данных не всегда требуется шлюз, он является обязательным, если набор данных подключается и к локальным, и к облачным источникам в рамках одного комбинированного запроса. В этом случае служба Power BI должна использовать шлюз и для облачных источников данных. На следующей схеме показано, как такой набор данных обращается к своим источникам данных.

![Облачные и локальные источники данных](media/refresh-data/cloud-on-premises-data-sources-diagram.png)

> [!NOTE]
> Если набор данных использует отдельные комбинированные запросы для подключения к локальным и облачным источникам, Power BI использует подключение шлюза для обращения к локальным источникам и прямое сетевое подключение к облачным источникам. Если комбинированный запрос объединяет или добавляет данные из локальных и облачных источников, Power BI переключается на подключение шлюза даже для облачных источников.

Наборы данных Power BI используют Power Query для доступа к данным из источника и их получения. В следующем комбинированном листинге показан простой пример запроса, который объединяет данные из локального источника и облачного источника.

```
Let

    OnPremSource = Sql.Database("on-premises-db", "AdventureWorks"),

    CloudSource = Sql.Databases("cloudsql.database.windows.net", "AdventureWorks"),

    TableData1 = OnPremSource{[Schema="Sales",Item="Customer"]}[Data],

    TableData2 = CloudSource {[Schema="Sales",Item="Customer"]}[Data],

    MergedData = Table.NestedJoin(TableData1, {"BusinessEntityID"}, TableData2, {"BusinessEntityID"}, "MergedData", JoinKind.Inner)

in

    MergedData
```

Настроить шлюз данных для поддержки объединения или добавление данных из локальных и облачных источников можно двумя способами:

- Добавьте определение источника данных для облачного источника на шлюз данных в дополнение к локальным источникам данных.
- Установите флажок **Разрешить обновлять облачные источники данных пользователя через этот кластер шлюза**.

![Обновление через кластер шлюза](media/refresh-data/refresh-gateway-cluster.png)

Если вы установили флажок **Разрешить обновлять облачные источники данных пользователя через этот кластер шлюза** в конфигурации шлюза, как показано на снимке экрана выше, Power BI может использовать конфигурацию, определенную пользователем для облачного источника в разделе **Учетные данные источников данных** параметров набора данных. Это помогает сократить временные затраты на настройку шлюза. С другой стороны, если вы хотите полнее контролировать подключения, устанавливаемые шлюзом, устанавливать этот флажок не следует. В этом случае нужно добавить на шлюз явное определение источника данных для каждого облачного источника, который требуется поддерживать. Можно также установить этот флажок и добавить явные определения источника данных для ваших облачных источников на шлюз. В этом случае шлюз использует определения источника данных для всех соответствующих источников.

### <a name="configuring-query-parameters"></a>Настройка параметров запроса

Комбинированные запросы или запросы M, создаваемые с помощью Power Query, могут иметь разную сложность — от стандартных шагов до параметризованных конструкций. В следующем листинге показан небольшой пример комбинированного запроса, который использует два параметра _SchemaName_ и _TableName_ для обращения к заданной таблице в базе данных AdventureWorks.

```
let

    Source = Sql.Database("SqlServer01", "AdventureWorks"),

    TableData = Source{[Schema=SchemaName,Item=TableName]}[Data]

in

    TableData
```

> [!NOTE]
> Параметры запросов поддерживаются только для наборов данных в режиме импорта. Режим DirectQuery/LiveConnect не поддерживает определения параметров запроса.

Чтобы убедиться, что параметризованный набор данных обращается к правильным данным, нужно настроить параметры комбинированного запроса в параметрах набора данных. Вы также можете изменить эти параметры программным образом с помощью [REST API Power BI](/rest/api/power-bi/datasets/updateparametersingroup). На снимке экрана ниже показан пользовательский интерфейс для настройки параметров запроса для набора данных, который использует приведенный выше комбинированный запрос.

![Настройка параметров запроса](media/refresh-data/configure-query-parameters.png)

> [!NOTE]
> Сейчас Power BI не поддерживает параметризованные определения источника данных, которые также называются динамическими источниками данных. Например, вы не можете параметризовать функцию доступа к данным Sql.Database("SqlServer01", "AdventureWorks"). Если ваш набор данных основан на динамических источниках данных, Power BI сообщает об обнаружении неизвестных или неподдерживаемых источников данных. Чтобы служба Power BI могла идентифицировать такие источники данных и подключиться к ним, вам нужно заменить параметры в функциях доступа к данным статическими значениями. Дополнительные сведения см. в разделе [Устранение неполадок с источником данных, не поддерживающим обновление](service-admin-troubleshoot-unsupported-data-source-for-refresh.md).

## <a name="configure-scheduled-refresh"></a>Настройка запланированного обновления

Обеспечение взаимодействия между Power BI и источниками данных является наиболее сложной задачей при настройке обновления данных. Оставшиеся шаги довольно просты и включают в себя настройку расписания обновления и включение уведомлений об ошибках обновления. Пошаговые инструкции см. в практическом руководстве [Настройка запланированного обновления](refresh-scheduled-refresh.md).

### <a name="setting-a-refresh-schedule"></a>Настройка расписания обновления

В разделе **Запланированное обновление** можно определить частоту и периоды времени для обновления набора данных. Как упоминалось ранее, можно настроить до восьми ежедневных периодов времени, если набор данных находится в общей емкости, или 48 периодов в Power BI Premium. На следующем снимке экрана показано расписание обновления с 12-часовым интервалом.

![Настройка запланированного обновления](media/refresh-data/configure-scheduled-refresh.png)

Настроив расписание обновления, вы сможете получать сведения о времени следующего обновления на странице параметров набора данных, как показано на снимке экрана выше. Если вы хотите обновить данные раньше, например, чтобы проверить конфигурацию шлюза и источников данных, вы можете выполнить обновление по запросу, выбрав **Обновить** в меню набора данных в области навигации. Обновления по запросу не влияют на следующее запланированное время обновления.

Обратите внимание, что настроенное время обновления может не соответствовать точному времени запуска следующего запланированного процесса службой Power BI. Power BI запускает запланированные обновления в оптимальное время. Цель заключается в запуске обновления в пределах 15 минут от запланированного периода времени, однако может иметь место задержка до одного часа, если службе не удается выделить требуемые ресурсы быстрее.

> [!NOTE]
> Служба Power BI деактивирует ваше расписание обновления после четырех последовательных сбоев или после обнаружения неустранимой ошибки, которая требует обновить конфигурацию, например, когда учетные данные недействительны или истек их срок действия. Изменить пороговое значение последовательных сбоев невозможно.

### <a name="getting-refresh-failure-notifications"></a>Получение уведомлений об ошибках обновления

По умолчанию Power BI отправляет уведомления об ошибках обновления по электронной почте владельцу набора данных, чтобы он мог своевременно принять меры при возникновении проблем. Power BI также отправляет вам уведомление, когда служба отключает ваше расписание из-за последовательных сбоев. Корпорация Майкрософт рекомендует оставить флажок **Отправлять уведомления об ошибках обновления мне по электронной почте** установленным.

Кроме того, рекомендуется указывать дополнительных получателей, используя текстовое поле **Отправлять этим пользователям сообщение электронной почты при сбое обновления**. Указанные получатели получают уведомления об ошибках обновления вместе с владельцем набора данных. Это может быть коллега, который следит за вашими наборами данных, пока вы находитесь в отпуске. Это также может быть псевдоним электронной почты вашей группы поддержки, которая отвечает за решение проблем с обновлением в вашем отделе или вашей организации. Отправка уведомлений об ошибках обновления другим пользователям в дополнение к владельцу набора данных помогает своевременно обнаружить проблемы и устранить их.

Обратите внимание, что Power BI отправляет уведомления не только при ошибках обновления, но и при приостановке запланированного обновления из-за отсутствия активности. Power BI считает набор данных неактивным, если пользователи не открывали никакие основанные на нем панели мониторинга или отчеты в течение двух месяцев. В этом случае Power BI отправляет сообщение электронной почты владельцу набора данных, сообщая о приостановке расписания обновления для этого набора данных. На снимке экрана ниже приведен пример такого уведомления.

![Сообщение электронной почты о приостановке обновления](media/refresh-data/email-paused-refresh.png)

Чтобы возобновить запланированное обновление, посетите отчет или панель мониторинга, созданные с помощью этого набора данных, и вручную обновите набор данных с помощью параметра **Обновить сейчас**.

### <a name="checking-refresh-status-and-history"></a>Проверка состояния обновления и журнала

Кроме использования уведомлений о сбоях, рекомендуется периодически проверять наборы данных на наличие ошибок обновления. Чтобы сделать это быстро, можно просмотреть список наборов данных в рабочей области. Для наборов данных с ошибками отображается небольшой значок предупреждения. Выберите его, чтобы получить дополнительную информацию, как показано на снимке экрана ниже. Дополнительные сведения об устранении конкретных ошибок обновления см. в статье [Устранение неполадок в сценариях обновления](refresh-troubleshooting-refresh-scenarios.md).

![Предупреждение о состоянии обновления](media/refresh-data/refresh-status-warning.png)

Этот значок предупреждения указывает на наличие проблем с набором данных, но также рекомендуется периодически проверять журнал обновлений. Как и предполагает название, журнал обновлений позволяет узнать состояние успеха или сбоя для последних циклов синхронизации. Например, администратор шлюза мог обновить набор учетных данных базы данных с истекшим сроком действия. Как показано на снимке экрана ниже, журнал обновлений сообщает, когда затронутое обновление снова начало выполняться.

![Сообщения журнала обновлений](media/refresh-data/refresh-history-messages.png)

> [!NOTE]
> Вы можете найти ссылку для отображения журнала обновлений в параметрах набора данных. Вы также можете получить журнал обновлений программным образом с помощью [REST API Power BI](/rest/api/power-bi/datasets/getrefreshhistoryingroup). С помощью пользовательского решения вы можете централизованно отслеживать журнал обновлений для нескольких наборов данных.

## <a name="automatic-page-refresh"></a>Автоматическое обновление страницы

Автоматическое обновление страницы работает на уровне страницы отчета и позволяет авторам отчетов задавать интервал обновления для визуальных элементов на странице. Такая возможность активна только при использовании страницы. Автоматическое обновление страницы доступно только для источников данных DirectQuery. Минимальный интервал обновления зависит от типа рабочей области, в которой опубликован отчет, и параметров администрирования емкости для рабочих областей Premium и [Embedded](developer/embedded/embedding.md).

Дополнительные сведения об автоматическом обновлении страниц см. в [этой статье](desktop-automatic-page-refresh.md).

## <a name="best-practices"></a>Советы и рекомендации

Регулярная проверка журнала обновлений для наборов данных является одной из наиболее важных рекомендаций, позволяющей убедиться, что отчеты и панели мониторинга используют актуальные данные. При обнаружении проблем оперативно устраните их и проведите дальнейшую работу вместе с владельцами источников данных и администраторами шлюза, если это необходимо.

Кроме того, учитывайте следующие рекомендации по реализации и обслуживанию надежных процессов обновления данных для наборов данных:

- Планируйте обновления на периоды пониженной нагрузки, особенно в том случае, если ваши наборы данных находятся в Power BI Premium. Распределив циклы обновления для наборов данных по более широкому временному интервалу, вы можете предотвратить пиковые нагрузки, способные перегрузить доступные ресурсы. Задержки при запуске цикла обновления указывают на перегрузку ресурсов. Если возможности емкости Premium полностью исчерпаны, Power BI может даже пропустить цикл обновления.
- Не забывайте об ограничениях обновления. Если источник данных часто изменяется или обрабатывается значительный объем данных, рекомендуется использовать режим DirectQuery/LiveConnect вместо режима импорта при условии, что повышенная нагрузка в источнике и влияние на производительность запросов являются приемлемыми. Избегайте постоянного обновления набора данных в режиме импорта. Однако режим DirectQuery/LiveConnect имеет несколько ограничений, таких как ограничение на один миллион строк при возвращении данных и ограничение по времени ответа в 225 секунд при выполнении запросов, как описано в статье [Использование DirectQuery в Power BI Desktop](desktop-use-directquery.md). Эти ограничения могут вынудить вас использовать режим импорта. Для очень больших объемов данных рассмотрите возможность использования [агрегатов в Power BI](desktop-aggregations.md).
- Убедитесь, что время обновления набора данных не превышает максимальную длительность обновления. Используйте Power BI Desktop для проверки длительности обновления. Если она превышает 2 часа, рекомендуется переместить набор данных в Power BI Premium. Ваш набор данных может не поддерживать обновления в общей емкости. Также рассмотрите возможность использования [добавочного обновления в Power BI Premium](service-premium-incremental-refresh.md) для наборов данных, у которых размер превышает 1 ГБ или обновление занимает несколько часов.
- Оптимизируйте наборы данных, включив только те таблицы и столбцы, которые используют ваши отчеты и панели мониторинга. Оптимизируйте комбинированные запросы и по возможности избегайте динамических определений источников данных и дорогостоящих вычислений DAX. В частности, избегайте функций DAX, которые проверяют каждую строку в таблице, так как они потребляют много памяти и вычислительных ресурсов.
- Примените те же параметры конфиденциальности, что и в Power BI Desktop, чтобы служба Power BI могла создавать эффективные исходные запросы. Помните, что Power BI Desktop не публикует параметры конфиденциальности. Вам нужно повторно применить эти параметры вручную в определениях источника данных после публикации набора данных.
- Ограничьте количество визуальных элементов на панелях мониторинга, особенно при использовании [безопасности на уровне строк (RLS)](service-admin-rls.md). Как указано выше, слишком большое количество плиток на панели мониторинга может значительно увеличить длительность обновления.
- Используйте надежное развертывание корпоративного шлюза данных для подключения своих наборов данных к локальным источникам данных. Если вы заметили сбои обновления, связанные со шлюзом, например, когда шлюз недоступен или перегружен, обратитесь к администраторам шлюза, чтобы добавить дополнительные шлюзы в существующий кластер или развернуть новый кластер (вертикальное или горизонтальное масштабирование).
- Используйте отдельные шлюзы данных для наборов данных импорта и наборов данных DirectQuery/LiveConnect, чтобы импорт данных во время запланированного обновления не влиял на производительность отчетов и панелей мониторинга, основанных на наборах данных DirectQuery/LiveConnect, которые запрашивают источники данных при каждом взаимодействии с пользователем.
- Убедитесь, что Power BI может отправлять уведомления об ошибках обновления в ваш почтовый ящик. Фильтры нежелательной почты могут блокировать такие сообщения электронной почты или перемещать их в отдельную папку, где вы можете заметить их не сразу.


## <a name="next-steps"></a>Дальнейшие действия

[Настройка запланированного обновления](refresh-scheduled-refresh.md)  
[Средства для устранения неполадок при обновлении](service-gateway-onprem-tshoot.md)  
[Устранение неполадок в сценариях обновления](refresh-troubleshooting-refresh-scenarios.md)  

Появились дополнительные вопросы? [Попробуйте задать вопрос в сообществе Power BI.](https://community.powerbi.com/)
