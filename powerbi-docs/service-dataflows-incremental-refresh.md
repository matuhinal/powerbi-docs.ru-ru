---
title: Использование добавочного обновления для потоков данных Power BI
description: Сведения о настройке добавочного обновления для потоков данных
author: mgblythe
manager: kfile
ms.reviewer: kayu
ms.service: powerbi
ms.subservice: powerbi-service
ms.topic: conceptual
ms.date: 04/02/2019
ms.author: mblythe
LocalizationGroup: Data from files
ms.openlocfilehash: 7e9d8779480eb7a00dacfc9fc52fc81987629e7b
ms.sourcegitcommit: 1789815c87e306b1427a5838655d30d3b9ba1d29
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67791935"
---
# <a name="using-incremental-refresh-with-power-bi-dataflows"></a>Использование добавочного обновления для потоков данных Power BI

Потоки данных позволяют вам добавлять в Power BI большие объемы данных для создания привлекательных отчетов и аналитики. Но в некоторых случаях получать полную копию источника данных при каждом обновлении нецелесообразно. Более предпочтительным вариантом будет использовать **добавочное обновление**, которое предоставляет ряд преимуществ для потоков данных:

* **Обновление происходит быстрее** — обновлять нужно только те данные, которые изменились. Например, в потоке данных за 10 лет будут обновляться данные только за последние пять дней.
* **Обновление становится надежнее** — например, нет необходимости надолго подключаться к нестабильным исходным системам.
* **Снижается потребление ресурсов** — так как обновлять требуется меньше данных, сокращается общее потребление памяти и других ресурсов.

![Добавочное обновление для потоков данных](media/service-dataflows-incremental-refresh/dataflows-incremental-refresh_03.png)

При использовании добавочных обновлений для потоков данных Power BI требуется, чтобы рабочая область потока данных размещалась в [емкости Premium](service-premium-what-is.md), а источник данных для потока данных поддерживал поле *datetime*, чтобы фильтровать по нему данные для добавочного обновления. 

## <a name="configuring-incremental-refresh-for-dataflows"></a>Настройка добавочного обновления для потоков данных

Поток данных может содержать множество сущностей. Добавочное обновление настраивается на уровне сущности, что позволяет включить в один поток данных сущности с полным обновлением и сущности с добавочным обновлением.

Чтобы настроить сущности с добавочным обновлением, прежде всего создайте и настройте их как обычные сущности. Дополнительные сведения о настройке потока данных см. в руководстве по [самостоятельной подготовке данных в Power BI](service-dataflows-overview.md).

Завершив создание и сохранение потока данных, выберите значок **добавочного обновления** в представлении сущности, как показано на следующем рисунке.

![Значок добавочного обновления для потоков данных](media/service-dataflows-incremental-refresh/dataflows-incremental-refresh_01.png)

Когда вы щелкните этот значок, появится окно **Параметры добавочного обновления**. Переведите переключатель добавочного обновления в положение **Вкл.** и настройте соответствующие параметры.

![Добавочное обновление для потоков данных](media/service-dataflows-incremental-refresh/dataflows-incremental-refresh_03.png)

В следующем списке описаны параметры, которые можно настроить в окне **Параметры добавочного обновления**. 

1. **Переключатель включения (отключения) добавочного обновления** – этот ползунок активирует политику добавочного обновления для сущности.
2. **Поле фильтра с раскрывающимся списком** — выбирает поле запроса, по которому будут фильтроваться сущности для добавочного обновления. Это поле содержит только поля типа *datetime*. Вы не сможете использовать добавочное обновление, если сущность не содержит поля *datetime*.
3. **Store rows from the past** (Хранить строки за прошлый период) — следующий пример демонстрирует применение нескольких параметров.

    В этом примере определяется политика обновления для хранения данных, добавленных за последние пять лет, а также добавочного обновления данных за последние 10 дней. Если сущность обновляется ежедневно, при каждой такой операции выполняются следующие действия:

    * Добавляются данные за последний день.
    * Обновляются данные за последние 10 дней до текущей даты.
    * Удаляются данные за календарные годы старше пяти лет до текущей даты. Например, если сегодня 1 января 2019 г., удаляются данные за 2013 г.

    При первом обновлении потока данных может потребоваться некоторое время на импорт данных за пять лет, но все последующие обновлениях, скорее всего, будут занимать гораздо меньше времени.

4. **Обнаруживать изменения данных** — добавочное обновление гораздо эффективнее, чем полное обновление данных за пять лет, но мы сможем сделать еще лучше. Установив флажок **Обнаруживать изменения данных**, вы сможете выбрать столбец типа datetime, по которому будут определяться дни изменения данных. Так обновляться будут данные только за эти дни. Предполагается, что в исходной системе есть такой столбец. Обычно он предназначен для аудита. Для каждого из периодов в диапазоне добавочного обновления вычисляется максимальное значение этого столбца. Если оно не изменилось с момента последнего обновления, обновлять данные за этот период не нужно. Благодаря этому в примере число дней, за которые нужно обновить данные, может уменьшиться, например, с 10 до двух.

> [!TIP]
> Сейчас требуется, чтобы столбец, который служит для обнаружения изменений данных, был хранимым и кэшировался в памяти. Чтобы уменьшить кратность и потребление памяти, можно воспользоваться одним из описанных ниже приемов:
>
>    * Сохраняйте только максимальное значение этого столбца во время обновления, например, с помощью функции Power Query.
>    * Уменьшите точность до приемлемого уровня с учетом требований к частоте обновления.


5. **Only refresh complete periods** (Обновлять только завершенные периоды) — предположим, что обновление запланировано на 4:00 ежедневно. Данные, накопившиеся в исходной системе за первые четыре часа дня, вам пока не нужны. Многие бизнес-метрики, например количество баррелей в день в нефтегазовой отрасли, нет смысла использовать в виде неполных данных, собранных за день.

    Другой пример, в котором вам будут интересны только завершенные периоды, — обновление данных финансовой системы. Предположим, данные в финансовой системе за предыдущий месяц утверждаются в 12-й календарный день месяца. В этом случае можно задать диапазон добавочного обновления длительностью в месяц и настроить запуск обновления в 12-й день месяца. При таких настройках данные за январь (последний полный месяц) будут обновляться 12-го февраля.

> [!NOTE]
> При добавочном обновлении потока данных для выбора дат применяется следующая логика: если запланировано добавочное обновление для потока, оно выполняется по времени часового пояса, указанного в политике обновления. Если расписание обновления отсутствует, добавочное обновление выполняется по времени локального компьютера, на котором оно запущено.

## <a name="the-incremental-refresh-query"></a>Запрос добавочного обновления

Когда вы настроите добавочное обновление, поток данных автоматически скорректирует запрос, добавив в него фильтр по дате. Вы можете изменить автоматически созданный запрос, используя **расширенный редактор Power Query**, чтобы персонализировать или настроить правила обновления. В следующем разделе приведены дополнительные сведения о добавочном обновлении и принципах его работы.

## <a name="incremental-refresh-and-linked-versus-computed-entities"></a>Добавочное обновление для связанных и вычисляемых сущностей

Для *связанных* сущностей добавочное обновление изменяет исходную сущность. Связанные сущности по сути являются просто указателями на исходную сущность, поэтому добавочное обновление никак не влияет на них. Когда исходная сущность обновится в соответствии с определенной для нее политикой обновления, все связанные сущности будут вести себя так, будто данные в источнике обновились.

*Вычисляемые* сущности основаны на запросах, выполняемых в хранилище данных, в том числе в другом потоке данных. Это означает, что вычисляемые сущности ведут себя так же, как связанные сущности.

Так как поведение вычисляемых и связанных сущностей почти не отличается, для них применимы одинаковые требования и этапы настройки. Единственное важное отличие заключается в том, что для некоторых конфигураций вычисляемых сущностей добавочное обновление не может работать оптимизированным образом из-за особенностей структуры разделов. 

## <a name="changing-between-incremental-and-full-refresh"></a>Переключение между добавочным и полным обновлением

Потоки данных поддерживают переключение политики обновления между добавочным и полным обновлением. Такое изменение в любом направлении (с полного на добавочное или с добавочного на полное) влияет на поток данных после следующего обновления.

Если поток данных переключается с полного обновления на добавочное, новая логика обновления обновляет поток данных с учетом окна обновления и шага приращения, которые настроены в параметрах добавочного обновления.

Если поток данных переключается с добавочного обновления на полное, все накопленные за время добавочного обновления данные перезаписывается с соблюдением политики, определенной для полного обновления. Такое действие требует подтверждения.


## <a name="dataflow-incremental-refresh-and-datasets"></a>Добавочное обновление потока данных и наборы данных

Предполагается, что добавочное обновление потока данных и набора данных будет использоваться совместно. Допустимы и поддерживаются следующие сценарии: для сущности в потоке данных применяется добавочное обновление, а затем она целиком загружается в набор данных, или полностью загружаемая в поток данных сущность добавочно обновляется в наборе данных. 

Оба подхода зависят от настроенных в параметрах обновления определений.
См. дополнительные сведения о [добавочном обновлении в Power BI Premium](service-premium-incremental-refresh.md).

## <a name="time-zone-support-in-incremental-refresh"></a>Поддержка часовых поясов для добавочного обновления

Поведение добавочного обновления потока данных зависит от времени его выполнения. Фильтрация запроса зависит от дня, в который он выполняется.

Чтобы учитывать такие зависимости и поддерживать согласованность данных, добавочное обновление для потоков данных использует следующую эвристику для сценариев *немедленного обновления*:

* Если в системе определено обновление по расписанию, добавочное обновление использует параметры часового пояса для этого запланированного обновления. Это гарантирует, что часовой пояс, настроенный для пользователя, который обновляет поток данных, всегда будут согласовываться с расписанием, определенными в системе.

* Если обновление по расписанию не определено, потоки данных будут использовать часовой пояс, настроенный на локальном компьютере пользователя, выполняющего обновление.

Также добавочное обновление можно вызвать с помощью API. В этом случае вызов API может содержать параметр часового пояса, который используется при обновлении. Кроме того, API могут быть полезны при тестировании и проверке.


## <a name="incremental-refresh-implementation-details"></a>Сведения о реализации добавочного обновления

Потоки данных используют для добавочного обновления секционирование. Как только появляются конечные точки XMLA для Power BI Premium, секции становятся видимыми. Добавочное обновление в потоках данных сохраняет минимально необходимое количество секций в соответствии с требованиями политики обновления. Старые секции, вышедшие за пределы диапазона скользящего окна, удаляются. Секции рационально объединяются, что уменьшает общее число необходимых секций. Благодаря этому улучшается сжатие, а в некоторых случаях и повышается производительность запросов.

Для всех примеров в этом разделе применяется единая политика обновления:

* сохранять строки за последний 1 квартал;
* обновлять строки за последние 10 дней;
* не обнаруживать изменения данных;
* обновлять только данные за полные дни.


### <a name="merge-partitions"></a>Объединение секций

В этом примере секции с данными, полученными за день, автоматически объединяются по месяцам, как только они выходят за пределы добавочного обновления. Секции в пределах диапазона добавочного обновления обрабатываются в определенные дни, чтобы разрешить обновление данных только за эти дни.
Операция обновления с *датой запуска 11 декабря 2016 г.* объединяет все дни в ноябре, так как они выходят за пределы диапазона добавочного обновления.

![Слияние секций в потоках данных](media/service-dataflows-incremental-refresh/dataflows-incremental-refresh_04.png)

### <a name="drop-old-partitions"></a>Удаление старых секций

Старые секции, выходящие за пределы полного диапазона хранения, удаляются. Операции обновления с *датой запуска 2 января 2017 г.* удаляет раздел за третий квартал 2016 г., так как он выходит за пределы полного диапазона.

![Удаление старых секций в потоках данных](media/service-dataflows-incremental-refresh/dataflows-incremental-refresh_05.png)

### <a name="recovery-from-prolonged-failure"></a>Восстановление после длительного сбоя

В этом примере имитируется корректное восстановление системы после длительного сбоя. Предположим, что обновление не удалось выполнить успешно из-за истечения срока действия учетных данных для источника данных, и решение этой проблема заняло 13 дней. Диапазон добавочного обновления составляет всего 10 дней.

Следующая успешная операция обновления выполняется с *датой запуска 15 января 2017 г.* , и ей нужно задним числом обработать и обновить отсутствующие 13 дней. Также ей нужно обновить предыдущие девять дней, так как они не обновлялись в рамках обычного расписания. Другими словами, диапазон добавочного обновления увеличивается с 10 до 22 дней.

Следующая операция обновления с *датой запуска 16 января 2017 г.* выполняет объединение дней в декабре и месяцев в четвертом квартале 2016 г.

![Восстановление после длительного сбоя в потоках данных](media/service-dataflows-incremental-refresh/dataflows-incremental-refresh_06.png)

## <a name="next-steps"></a>Дальнейшие действия

В этой статье описано добавочное обновление для потоков данных. Вот еще несколько статьей, которые могут быть полезны:


* [Self-service data prep in Power BI (Preview)](service-dataflows-overview.md) (Самостоятельная подготовка данных в Power BI (предварительная версия))
* [Creating and using dataflows in Power BI (Preview)](service-dataflows-create-use.md) (Создание и использование потоков данных в Power BI (предварительная версия))
* [Использование потоков данных с локальными источниками данных](service-dataflows-on-premises-gateways.md)
* [Ресурсы для разработчиков потоков данных Power BI](service-dataflows-developer-resources.md)

Дополнительные сведения о Power Query и обновлении по расписанию содержатся в следующих статьях:
* [Общие сведения о запросах в Power BI Desktop](desktop-query-overview.md)
* [Настройка запланированного обновления](refresh-scheduled-refresh.md)

Дополнительные сведения о модели общих данных вы найдете в этой обзорной статье:
* [Что такое модель общих данных?](https://docs.microsoft.com/powerapps/common-data-model/overview)

