---
title: Использование составных моделей в Power BI Desktop
description: Создание моделей данных с несколькими подключениями к данным и связей "многие ко многим" в Power BI Desktop
author: davidiseminger
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: conceptual
ms.date: 01/15/2020
ms.author: davidi
LocalizationGroup: Transform and shape data
ms.openlocfilehash: 5d7e4be9e3b864e2ccfccf64ac0d4460d0821e0a
ms.sourcegitcommit: 0e9e211082eca7fd939803e0cd9c6b114af2f90a
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/13/2020
ms.locfileid: "83326594"
---
# <a name="use-composite-models-in-power-bi-desktop"></a>Использование составных моделей в Power BI Desktop

Ранее в Power BI Desktop при использовании DirectQuery в отчете не допускались никакие другие подключения к данным в этом отчете, будь то DirectQuery или импорт. В составных моделях это ограничение снимается. В отчет теперь можно беспрепятственно включать подключения к данным из нескольких DirectQuery или импортировать подключения к данным в любой выбранной комбинации.

Возможность создания составных моделей в Power BI Desktop сопряжена с использованием трех основных компонентов:

* **Составные модели.** Они позволяют включить в отчет несколько подключений к данным, в том числе подключения DirectQuery или импорт, в любой комбинации. В этой статье приведено подробное описание составных моделей.

* **Связи "многие ко многим"** . В составных моделях вы можете установить между таблицами связи *многие ко многим*. Они избавляют от необходимости поддерживать уникальные значения в таблицах. Также они позволяют обойтись без предыдущих обходных путей, таких как создание новых таблиц исключительно для образования связей. Дополнительные сведения см. в статье [Применение связей "многие ко многим" в Power BI Desktop](desktop-many-to-many-relationships.md).

* **Режим хранения.** Он позволяет указать, в каких визуальных элементах будут использоваться запросы к источникам данных серверной части. Визуальные элементы, которым не нужны такие запросы, всегда импортируются, даже если они основаны на DirectQuery. Эта функция помогает повысить производительность и снизить нагрузку на серверную часть. Ранее даже простые визуальные элементы, например срезы, инициировали запросы к серверным источникам. Дополнительные сведения см. в статье [Управление режимом хранения в Power BI Desktop](desktop-storage-mode.md).

## <a name="use-composite-models"></a>Работа с составными моделями

Составные модели дают возможность подключаться к различным типам источников данных при использовании Power BI Desktop или службы Power BI. Эти подключения данных можно выполнять двумя способами:

* путем импорта данных в Power BI (наиболее распространенный способ получения данных);
* путем подключения непосредственно к данным в исходном репозитории с помощью DirectQuery. Дополнительные сведения о DirectQuery см. в статье [Использование DirectQuery в Power BI](../connect-data/desktop-directquery-about.md).

При использовании DirectQuery составные модели позволяют создать модель Power BI (например, одиночный *PBIX-файл* Power BI Desktop), предназначенную для выполнения одной или обеих следующих действий:

* объединение данных из одного или нескольких источников DirectQuery;
* объединение данных из источников DirectQuery и импортированных данных.

Например, с помощью составных моделей можно построить модель, которая объединяет следующие типы данных:

* данные о продажах из хранилища данных предприятия;
* данные о целевых продажах из базы данных SQL Server отделов предприятия;
* данные, импортированные из электронной таблицы.

Модель, которая объединяет данные из нескольких источников DirectQuery или объединяет DirectQuery с импортированными данными, называется составной моделью.

Связи между таблицами можно создавать всегда, даже если эти таблицы берутся из разных источников. Отношения между источниками создаются с кратностью "многие ко многим" независимо от фактической кратности. Их можно изменить на "один ко многим", "многие к одному" или "один к одному". В зависимости от того, какая кратность задается, связи между источниками имеют различное поведение. Функции выражений анализа данных (DAX) нельзя использовать для получения значений на стороне `one` от стороны `many`. Кроме того, может быть заметно снижение производительности по сравнению со связями "многие ко многим" в одном и том же источнике.

> [!NOTE]
> В контексте составных моделей все импортированные таблицы по сути представляют собой единый источник независимо от фактических базовых источников данных.

## <a name="example-of-a-composite-model"></a>Пример составной модели

В качестве примера составной модели рассмотрим отчет, который подключен к корпоративному хранилищу данных в SQL Server с помощью DirectQuery. В этом случае хранилище данных содержит данные **Sales by Country** (Продажи по странам), **Quarter** (Квартал) и **Bike (Product)** (Велосипеды, продукт), как показано на следующем рисунке:

![Представление связей для составных моделей](media/desktop-composite-models/composite-models_04.png)

На этом этапе можно создать простые визуальные элементы с использованием полей из указанного источника. На следующем рисунке показаны сведения об общем объеме продаж по наименованиям продукции (*ProductName*) для выбранного квартала.

![Визуальный элемент на основе данных](media/desktop-composite-models/composite-models_05.png)

Но что делать, если у вас есть электронная таблица Office Excel с данными о менеджерах по продуктам, назначенных для каждого продукта, наряду с маркетинговым приоритетом? Если вы хотите просмотреть значение **Sales Amount** (Объем продаж) по **менеджеру по продуктам**, может оказаться невозможным добавить эти локальные данные в корпоративное хранилище данных. Или это в лучшем случае может занять месяцы.

Существует возможность импортировать эти данные о продажах из хранилища данных вместо использования DirectQuery. Затем данные о продажах можно объединить с данными, которые импортируются из электронной таблицы. Тем не менее этот подход является неоправданным по причинам, из-за которых рекомендуется в первую очередь использовать DirectQuery. Возможные причины включают следующие:

* определенное сочетание правил безопасности, применяемых в базовом источнике;
* необходимость просматривать последние данные;
* масштабы отклонения данных.

Здесь и помогают составные модели. Составные модели позволяют подключиться к хранилищу данных с помощью DirectQuery, а затем использовать функцию **Получение данных** для дополнительных источников. В этом примере мы сначала установим подключение DirectQuery к корпоративному хранилищу данных. Мы используем **Получение данных**, выберем **Excel**, а затем перейдем в электронную таблицу, содержащую наши локальные данные. Наконец, мы импортируем таблицу, содержащую *названия продуктов*, назначенного **менеджера по продажам** и **приоритет**.  

![Окно "Навигатор"](media/desktop-composite-models/composite-models_06.png)

В списке **Поля** вы увидите две таблицы: исходную таблицу **Bike** (Велосипеды) из SQL Server и новую таблицу **ProductManagers** (Менеджеры по продуктам). Новая таблица содержит данные, импортированные из Excel.

![Представление таблиц в списке "Поля"](media/desktop-composite-models/composite-models_07.png)

В **представлении связей** в Power BI Desktop теперь также отображается дополнительная таблица **ProductManagers**.

![Представление связей для таблиц](media/desktop-composite-models/composite-models_08.png)

Теперь нам нужно связать эти таблицы с другими в модели. Как всегда, мы создадим связь между таблицей **Bike** в SQL Server и импортированной таблицей **ProductManagers**. То есть связь будет установлена между **Bike[ProductName]** и **ProductManagers[ProductName]** . Как было сказано ранее, все связи между источниками по умолчанию будут иметь кратность "многие ко многим".

![Окно создания связи](media/desktop-composite-models/composite-models_09.png)

После создания этой связи она отображается в **представлении связей** в Power BI Desktop, как и ожидалось.

![Новое представление связей](media/desktop-composite-models/composite-models_10.png)

Теперь можно создать визуальные элементы на основе любого из полей в списке **Поля**. Этот подход позволяет без проблем объединять данные из нескольких источников. Например, общее значение *SalesAmount* (Объем продаж) для каждого *менеджера по продуктам* показано на следующем рисунке:

![Панель "Поля"](media/desktop-composite-models/composite-models_11.png)

В следующем примере показан распространенный вариант таблицы *измерения*, такой как **Продукт** или **Клиент**, которая расширяется с помощью некоторых дополнительных данных, импортированных из другого источника. Кроме того, таблицы могут использовать DirectQuery для подключения к различным источникам. Продолжая наш пример, представим, что данные о целях продаж (**Sales Targets**) по странам (**Country**) и периодам (**Period**) хранятся в отдельной базе данных отдела. Как обычно, подключиться к этим данным можно с помощью функции **Получение данных**, как показано на приведенном ниже рисунке.

![Окно "Навигатор"](media/desktop-composite-models/composite-models_12.png)

Как и ранее, мы можем создать связи между новой таблицей и другими таблицами в модели, а затем создать визуальные элементы, объединяющие данные таблиц. Вернемся к **представлению связей**, где мы установили новые связи.

![Представление связей с несколькими таблицами](media/desktop-composite-models/composite-models_13.png)

Пример на следующем рисунке основан на новых данных и связях, которые мы создали. Визуальный элемент в нижнем левом углу отражает сравнение общего объема продаж (*Sales Amount*) и целевого показателя (*Target*), а также вычисленное значение дисперсии. Данные **Sales Amount** и **Target** поступают из двух разных баз данных SQL Server.

![Рисунок с дополнительными данными](media/desktop-composite-models/composite-models_14.png)

## <a name="set-the-storage-mode"></a>Установка режима хранения

У каждой таблицы в составной модели есть режим хранения, указывающий, на чем основана таблица (на DirectQuery или импорте). Режим хранения можно просмотреть и изменить в области**Свойства**. Чтобы увидеть режим хранения, в списке **Поля** щелкните таблицу правой кнопкой мыши, а затем выберите пункт **Свойства**. На следующем рисунке показан режим хранения для таблицы **SalesTargets**.

Режим хранения также можно увидеть в подсказке для каждой таблицы.

![Подсказка с режимом хранения](media/desktop-composite-models/composite-models_16.png)

Для любого файла Power BI Desktop (с расширением *PBIX*), который содержит таблицы из DirectQuery и импортированные таблицы, в строке состояния режима хранения отображается значение **Смешанный**. Можно щелкнуть этот термин в строке состояния и переключить все таблицы в режим импорта.

Дополнительные сведения о режиме хранения см. в статье [Управление режимом хранения в Power BI Desktop](desktop-storage-mode.md).  

> [!NOTE]
> В Power BI Desktop и в службе Power BI можно использовать режим *смешанного* хранения.

## <a name="calculated-tables"></a>Вычисляемые таблицы

Вычисляемые таблицы можно добавить в модель, которая использует DirectQuery. Выражения анализа данных (DAX), определяющие вычисляемую таблицу, могут ссылаться на импортированные таблицы или таблицы DirectQuery, а также их сочетание.

Вычисляемые таблицы всегда импортируются, а данные в них обновляются при обновлении таблицы. Если вычисляемая таблица ссылается на таблицу DirectQuery, визуальные элементы, которые ссылаются на таблицу DirectQuery, всегда отображают последние значения в базовом источнике. Кроме того, визуальные элементы, ссылающиеся на вычисляемую таблицу, отображают значения на момент последнего обновления вычисляемой таблицы.

## <a name="security-implications"></a>Последствия для безопасности

Использование составных моделей связано с некоторыми последствиями для безопасности. Запрос, отправленный к одному источнику данных, может включать значения данных, полученные из другого источника. В предыдущем примере визуальный элемент, отображающий значение объема продаж (**Сумма продаж**) по менеджеру по продуктам (**Менеджер продукта**), отправляет запрос SQL к реляционной базе данных "Продажи". Этот запрос SQL может содержать имена Менеджеров по продуктам и связанные с ними продукты.

![Сценарий, демонстрирующий последствия для безопасности](media/desktop-composite-models/composite-models_17.png)

Соответственно, сведения, хранящиеся в электронной таблице, теперь включаются в запрос, отправляемый в реляционную базу данных. Если эти сведения конфиденциальны, необходимо учитывать последствия такого сценария для безопасности. В частности, необходимо учитывать следующие аспекты.

* Любой администратор базы данных, который может просматривать трассировки или журналы аудита, может увидеть эти сведения, даже не имея прав на доступ к ним в исходном источнике. В этом примере администратору потребовались бы разрешения на доступ к файлу Excel.

* Необходимо учитывать параметры шифрования для каждого источника. Наверняка вы хотели бы избежать ситуации, когда сведения получаются из одного источника через зашифрованное подключение, а затем случайно включаются в запрос, который отправляется к другому источнику через незашифрованное подключение.

Чтобы вы могли убедиться, что все последствия для безопасности приняты во внимание, при создании составной модели в Power BI Desktop отображается предупреждение.  

По тем же причинам нужно соблюдать осторожность при открытии файла Power BI Desktop, отправленного из ненадежного источника. Если файл содержит составные модели, сведения, получаемые из одного источника по учетным данным пользователя, который открывает файл, могут отправится в другой источник данных как часть запроса. При этом такие сведения может просмотреть автор вредоносного файла Power BI Desktop. При первом открытии файла Power BI Desktop, который содержит несколько источников, Power BI Desktop выводит на экран предупреждение. Это предупреждение аналогично отображающемуся при открытии файла с собственными запросами SQL.  

## <a name="performance-implications"></a>Влияние на производительность  

При использовании DirectQuery обязательно следует учитывать воздействие на производительность. Прежде всего убедитесь, что источник серверной части обладает достаточными ресурсами для обеспечения эффективной работы пользователей. Эффективная работа подразумевает, что визуальные элементы обновляются в течение не более пяти секунд. Дополнительные советы по повышению производительности см. в разделе [Использование DirectQuery в Power BI](../connect-data/desktop-directquery-about.md).

При использовании составных моделей следует учитывать дополнительные рекомендации по производительности. Один визуальный элемент может отправлять запросы в несколько источников, при этом результаты одного запроса часто передаются через второй источник. Это может привести к следующим формам выполнения.

* **SQL-запрос, который включает большое количество литеральных значений**. Например, визуальный элемент, запрашивающий общий объем продаж (**Sales Amount**) для набора выбранных **менеджеров по продуктам**, сначала должен узнать, какими **продуктами** управляют соответствующие менеджеры по продуктам. Эта последовательность должна быть выполнена, прежде чем визуальный элемент отправит запрос SQL, включающий все коды продуктов в предложении `WHERE`.

* **SQL-запрос, который выполняется на более низком уровне детализации, с данными, которые затем агрегируются локально**. По мере роста количества **продуктов**, удовлетворяющих условиям фильтра **Менеджер по продуктам**, включение всех продуктов в предложение `WHERE` может оказаться неэффективным или невозможным. Вместо этого можно запросить реляционный источник на более низком уровне **продуктов**, а затем агрегировать результаты локально. Если кратность **продуктов** превышает ограничение в 1 млн, запрос завершится ошибкой.

* **Несколько SQL-запросов, по одному на значение GROUP BY.** Если при агрегировании используется отличительное количество (**Число уникальных**), сгруппированное по определенному столбцу из другого источника, и внешний источник не поддерживает эффективную передачу нескольких литеральных значений, определяющих группирование, необходимо отправить по одному SQL-запросу на каждое значение GROUP BY.

   Визуальный элемент, запрашивающий отличительное количество **CustomerAccountNumber** из таблицы SQL Server по менеджерам по продуктам (**Product Managers**) импортированным из электронной таблицы, должен будет передать сведения из таблицы **Product Managers** в запросе, отправляемом в SQL Server. Для других источников, например, Redshift это невыполнимо. Вместо этого будет отправлено по одному SQL-запросу на каждого **менеджера по продажам** (до некоторого практического предела, при превышении которого запрос завершится ошибкой).

Каждый из этих случаев особым образом влияет на производительность. Конкретные последствия зависят от источника данных. Пока кратность столбцов, используемых в связи, объединяющей два источника, остается небольшой, несколько тысяч, это не должно оказывать влияния на производительность. При увеличении кратности следует уделить больше внимания влиянию на итоговую производительность.

Кроме того, использование связей "многие ко многим" означает, что отдельные запросы должны отправляться к базовому источнику для каждого итогового или промежуточного уровня вместо локального агрегирования детальных значений. Простой табличный визуальный элемент с итоговой суммой отправит два SQL-запроса, а не один.

## <a name="limitations-and-considerations"></a>Рекомендации и ограничения

В этом выпуске составные модели представляют несколько ограничений:

Сейчас [добавочное обновление](../admin/service-premium-incremental-refresh.md) поддерживается только для составных моделей, подключающихся к источникам данных SQL, Oracle и Teradata.

Следующие многомерные источники Live Connect невозможно использовать с составными моделями:

* SAP HANA
* SAP Business Warehouse
* Службы SQL Server Analysis Services
* Наборы данных Power BI
* Azure Analysis Services

При подключении к этим многомерным источникам в режиме DirectQuery невозможно одновременно подключиться к другому источнику DirectQuery или сочетать его с импортированными данными.

Существующие ограничения DirectQuery по-прежнему действуют при применении составных моделей. Многие из этих ограничений теперь относятся к отдельным таблицам в зависимости от режима хранения для каждой таблицы. Например, вычисляемый столбец в импортированной таблице может ссылаться на другие таблицы, но вычисляемый столбец в таблице DirectQuery по-прежнему ограничен ссылками только на столбцы той же таблицы. Другие ограничения применяются к модели в целом, если все таблицы в пределах модели являются таблицами DirectQuery. Например, функции "Краткая аналитика" и "Вопросы и ответы" недоступны в модели, если какая-либо из таблиц в ней используется в режиме хранения DirectQuery.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о составных моделях и DirectQuery см. в следующих статьях:

* [Связи "многие ко многим" в Power BI Desktop](desktop-many-to-many-relationships.md)
* [Режим хранения в Power BI Desktop](desktop-storage-mode.md)
* [Использование Power BI в DirectQuery](../connect-data/desktop-directquery-about.md)
* [Источники данных, поддерживаемые DirectQuery в Power BI](../connect-data/power-bi-data-sources.md)
