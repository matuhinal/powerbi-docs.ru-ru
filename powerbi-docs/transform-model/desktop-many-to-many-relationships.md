---
title: Связи "многие ко многим" в Power BI Desktop
description: Использование связей с кратностью "многие ко многим" в Power BI Desktop
author: davidiseminger
ms.reviewer: ''
ms.service: powerbi
ms.subservice: powerbi-desktop
ms.topic: conceptual
ms.date: 12/19/2019
ms.author: davidi
LocalizationGroup: Transform and shape data
ms.openlocfilehash: 17006405a495798618bf7562e6b94864b795a224
ms.sourcegitcommit: d153cfc0ce559480c53ec48153a7e131b7a31542
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/29/2020
ms.locfileid: "91528052"
---
# <a name="apply-many-many-relationships-in-power-bi-desktop"></a>Применение связей "многие ко многим" в Power BI Desktop

С помощью *связей с кратностью "многие ко многим"* в Power BI Desktop можно соединять таблицы, использующие кратность *многие ко многим*. Это позволяет более простым и интуитивно понятным образом создавать модели данных, которые содержат несколько источников данных. *Связи с кратностью "многие ко многим"* являются частью более широкого набора возможностей *составных моделей* в Power BI Desktop.

![Связь "многие ко многим" в области "Изменение связи", Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_01.png)

Создание *связей с кратностью "многие ко многим"* в Power BI Desktop реализовано в наборе из трех связанных функций.

* **Составные модели.** *Составные модели* позволяют включить в отчет несколько подключений к данным в любом сочетании, в том числе подключения DirectQuery или импорт. Дополнительные сведения см. в статье [Использование составных моделей в Power BI Desktop](desktop-composite-models.md).

* **Связи с кратностью "многие ко многим"** . В составных моделях между таблицами можно установить *связи с кратностью "многие ко многим"* . Они избавляют от необходимости поддерживать уникальные значения в таблицах. Также они позволяют обойтись без предыдущих обходных путей, например создания новых таблиц исключительно для образования связей. Эта функция подробно описана далее в этой статье.

* **Режим хранения** Он позволяет указать, в каких визуальных элементах будут использоваться запросы к источникам данных серверной части. Визуальные элементы, которым не нужны такие запросы, всегда импортируются, даже если они основаны на DirectQuery. Эта функция помогает повысить производительность и снизить нагрузку на серверную часть. Ранее даже простые визуальные элементы, например срезы, инициировали запросы к серверным источникам. Дополнительные сведения см. в статье [Режим хранения в Power BI Desktop](desktop-storage-mode.md).

## <a name="what-a-relationship-with-a-many-many-cardinality-solves"></a>Проблемы, решаемые связями с кратностью "многие ко многим"

Прежде чем стали доступны *связи с кратностью "многие ко многим"* , связь между двумя таблицами определялась в Power BI. Хотя бы один из столбцов таблиц, участвующих в связи, должен был содержать уникальные значения. Часто столбцы не содержали уникальные значения.

Например, две таблицы могли иметь столбец "Страна". Однако значения стран не уникальны в одной таблице. Чтобы соединить такие таблицы, требовалось обходное решение. Одним из возможных решений мог быть ввод дополнительных таблиц с необходимыми уникальными значениями. С помощью *связей с кратностью "многие ко многим"* такие таблицы можно соединять напрямую с помощью связей с кратностью *многие ко многим*.

## <a name="use-relationships-with-a-many-many-cardinality"></a>Использование связей с кратностью "многие ко многим"

При определении связи между двумя таблицами в Power BI необходимо определить кратность связи. Например, связь между ProductSales и Product&mdash;с использованием столбцов ProductSales[ProductCode] и Product[ProductCode]&mdash; будет определена как *многие к одному*. Мы определяем связь таким образом, поскольку имеется много продаж каждого продукта и столбец (ProductCode) таблицы Product является уникальным. При определении кратности связи как *многие к одному*, *один ко многим* или *один к одному* Power BI проверяет ее, чтобы кратность соответствовала фактическим данным.

Например, рассмотрим простую модель на изображении ниже.

![ProductSales и таблица Product, представление "Связи", Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_02.png)

Теперь представим, что в таблице **Product** отображаются лишь две строки, как показано:

![Визуальный элемент с двумя строками таблицы продуктов, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_03.png)

Также представьте таблицу Sales, содержащую всего четыре строки, включая строку для продукта C, которого не существует в таблице **Product** из-за ошибки ссылочной целостности.

![Визуальный элемент с двумя строками таблицы продаж, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_04.png)

Столбцы **ProductName** и **Price** (из таблицы **Product**), наряду с общим значением **Qty** (количество) для каждого продукта (из таблицы ProductSales), будут отображены, как показано на следующем изображении.

![Визуальный элемент с названием продукта, ценой и количеством, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_05.png)

Как показано на предыдущем рисунке, есть пустая строка **ProductName**, которая связана с продажами продукта C. Она отвечает за следующее.

* Все строки таблицы **ProductSales**, для которых не существует соответствующей строки в таблице **Product**. Существует проблема целостности данных, как показано в этом примере для продукта C.

* Любые строки в таблице **ProductSales**, для которых столбец внешнего ключа имеет значение NULL.

По этим причинам в обоих случаях пустая строка отвечает за продажи, в которых **ProductName** и **Price** неизвестны.

Бывают случаи, когда таблицы соединены по двум столбцам и при этом ни один из столбцов не уникален. Например, рассмотрим следующие две таблицы.

* Таблица **Sales** содержит данные о продажах по штатам (**State**), где в каждой строке указан объем продаж, соответствующий типу продаж в указанном штате (включая штаты CA, WA и TX).

    ![Таблица продаж, отображение продаж по штатам, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_06.png)

* Таблица **CityData** содержит данные по городам, в том числе сведения о населении и штате (такие как Калифорния, Вашингтон и Нью-Йорк).

    ![Таблица продаж, отображение города, штата и населения, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_07.png)

Столбец **Штат** теперь находится в обеих таблицах. Разумно, чтобы отчет выводился по общему объему продаж по штату и общему населению каждого штата. Однако существует проблема: столбец **Штат** не уникален ни в одной из таблиц.

## <a name="the-previous-workaround"></a>Использовавшийся ранее обходной путь

В версиях Power BI Desktop, предшествующих июльскому выпуску 2018 г., пользователи не могли создать прямую связь между такими таблицами. Обычным решением этой проблемы были следующие действия.

* Создание третьей таблицы, содержащей только уникальные идентификаторы штатов. Это может быть следующее.
  * Вычисляемая таблица (определяется на языке выражений анализа данных [DAX]).
  * Таблица на основе запроса, который определен в редакторе запросов; он может отображать уникальные идентификаторы, извлеченные из одной из таблиц.
  * Объединенный полный набор.

* Затем с помощью обычных связей *многие к одному* выполняется связывание двух исходных таблиц с этой новой таблицей.

Можно оставить таблицу возможного решения видимой. Кроме того, можно скрыть таблицу возможного решения, чтобы она не отображалась в списке **Поля**. Если скрыть таблицу, обычно для связей *многие к одному* включается фильтрация в обоих направлениях, что дает возможность использовать поле "Штат" любой из таблиц. Дальнейшая перекрестная фильтрация распространится на другую таблицу. Этот подход показан на следующем рисунке:

![Скрытая таблица "Штат", представление "Связи", Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_08.png)

Визуальный элемент с отображением поля **State** (из таблицы **CityData**) вместе с общей численностью населения (**Population**) и общим объемом продаж (**Sales**) будет выглядеть следующим образом.

![Снимок экрана: таблица с данными о штате, численности населения и продажах.](media/desktop-many-to-many-relationships/many-to-many-relationships_09.png)

> [!NOTE]
> При заданном использовании штата из таблицы **CityData** в решении в этой таблице перечисляются только соответствующие штаты (таким образом, штат Техас исключается). Кроме того, в отличие от связей *многие к одному*, хотя итоговая строка содержит весь **Объем продаж** (включая штат Техас), в подробные сведения не включается пустая строка, отвечающая за такие несовпадающие строки. Аналогично, не будет пустой строки, соответствующей каким-либо **продажам**, которым соответствует значение NULL поля **Штат**.

Предположим, что вы также добавляете "Город" в этот визуальный элемент. Несмотря на то что население в расчете на значение "Город" известно, значение **объема продаж**, показанное для "Город", просто повторит значение **объема продаж** для соответствующего **штата**. Этот сценарий обычно происходит, когда группирование столбцов не связано с некоторой статистической мерой, как показано ниже.

![Таблицы штата, населения города и продаж, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_10.png)

Предположим, что вы определили новую таблицу "Продажи" как сочетание штатов здесь и сделали ее видимой в списке **Поля**. Тот же визуальный элемент будет отображать **штат** (в новой таблице), **общее население** и **общий объем продаж**.

![Визуальный элемент со сведениями о штате, населении и продажах, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_11.png)

Как вы видите, включен штат TX &mdash;с данными **продаж**, но неизвестными данными о *населении* &mdash;и &mdash;Нью-Йорк с известным **населением**, но неизвестными данными &mdash;о **продажах**. Этот способ не оптимален и вызывает множество проблем. Связи с кратностью "многие ко многим" позволяют решить эти проблемы, как описано в следующем разделе.

## <a name="use-a-relationship-with-a-many-many-cardinality-instead-of-the-workaround"></a>Использование связей с кратностью "многие ко многим" вместо временного решения

Начиная июльской версии 2018 г., в Power BI Desktop можно напрямую связывать таблицы, например те, которые мы упоминали выше, не прибегая к использованию аналогичных временных решений. Теперь можно задать кратность связи *многие ко многим*. Этот параметр указывает, что ни одна из таблиц не содержит уникальные значения. Такие связи позволяют контролировать, какая таблица фильтрует другую таблицу. Либо можно применить двунаправленную фильтрацию, где каждая таблица фильтрует другую.

В Power BI Desktop по умолчанию задается кратность *многие ко многим*, когда программа определяет, что ни одна из таблиц не содержит уникальные значения столбцов связи. В таких случаях отображается предупреждение с сообщением о том, что вы хотите установить связь, и изменение не является случайным результатом проблемы с данными.

Например, при создании связи непосредственно между CityData и Sales&mdash;, где фильтры должны применяться от CityData к Sales, в &mdash;Power BI Desktop отображается диалоговое окно **Изменение связи**.

![Диалоговое окно "Изменение связи", Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_01.png)

Итоговое **представление связей** будет содержать прямую связь "многие ко многим" между двумя таблицами. Внешний вид таблиц в списке **Поля** и их последующее поведение при создании визуальных элементов аналогично ситуации, в которой мы применили обходной путь. Там мы создали дополнительную скрытую таблицу уникальных штатов. Как было сказано выше, отображается визуальный элемент со сведениями о **штате**, **населении** и **продажах**.

![Таблицы штата, населения и продаж, Power BI Desktop](media/desktop-many-to-many-relationships/many-to-many-relationships_12.png)

Основные различия между *связями с кратностью "многие ко многим"* и более распространенными связями *многие к одному* заключается в следующем.

* Значения, показываемые в них, не содержат пустую строку, отвечающую за несовпадающие строки в другой таблице. Кроме того, значения не отвечают за строки, в которых столбец, используемый для связи в другой таблице, имеет значение NULL.
* Использовать функцию `RELATED()` (так как связанными могут быть несколько строк) не удастся.
* При использовании функции `ALL()` в таблице не удаляются фильтры, примененные к другим таблицам, у которых с ней установлена связь "многие ко многим". В предыдущем примере мера, определенная согласно данному скрипту, не удалит фильтры по столбцам связанной таблицы CityData.

    ![Пример скрипта](media/desktop-many-to-many-relationships/many-to-many-relationships_13.png)

    Визуальный элемент с отображением **штата**, **объема продаж** и общего **объема продаж** будет таким, как на рисунке ниже.

    ![Визуальный элемент таблицы](media/desktop-many-to-many-relationships/many-to-many-relationships_14.png)

Учитывая перечисленные различия, убедитесь, что вычисления, использующие `ALL(<Table>)`, такие как *% от общей суммы*, возвращают желаемые результаты.

## <a name="limitations-and-considerations"></a>Рекомендации и ограничения

В этом выпуске для *связей с кратностью "многие ко многим"* и составных моделей есть несколько ограничений.

Следующие (многомерные источники) Live Connect нельзя использовать с составными моделями.

* SAP HANA
* SAP Business Warehouse
* Службы SQL Server Analysis Services
* Наборы данных Power BI
* Azure Analysis Services

При подключении к этим многомерным источникам в режиме DirectQuery невозможно одновременно подключиться к другому источнику DirectQuery или сочетать его с импортированными данными.

Существующие ограничения для DirectQuery по-прежнему применяются при использовании *связей с кратностью "многие ко многим"* . Многие ограничения теперь относятся к отдельным таблицам в зависимости от режима хранения для каждой таблицы. Например, вычисляемый столбец в импортированной таблице может ссылаться на другие таблицы, но вычисляемый столбец в таблице DirectQuery по-прежнему ограничен ссылками только на столбцы той же таблицы. Если какие-либо таблицы в пределах модели являются таблицами DirectQuery, к модели в целом применяются и другие ограничения. Например, функции "Краткая аналитика" и "Вопросы и ответы" недоступны в модели, если какая-либо из таблиц в ней используется в режиме хранения DirectQuery.

## <a name="next-steps"></a>Дальнейшие действия

Дополнительные сведения о составных моделях и DirectQuery см. в следующих статьях:
* [Использование составных моделей в Power BI Desktop](desktop-composite-models.md)
* [Режим хранения в Power BI Desktop](desktop-storage-mode.md)
* [Использование Power BI в DirectQuery](../connect-data/desktop-directquery-about.md)
* [Источники данных Power BI](../connect-data/power-bi-data-sources.md)
